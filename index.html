<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyRadar - India's Policy Intelligence Platform</title>
    <meta name="description" content="Track Indian policy developments across 270+ sources.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì°</text></svg>">
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --accent: #2563eb;
            --accent-light: #dbeafe;
            --critical: #dc2626;
            --critical-bg: #fef2f2;
            --high: #f59e0b;
            --high-bg: #fffbeb;
            --medium: #10b981;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --accent-light: #1e3a5f;
            --critical-bg: #450a0a;
            --high-bg: #451a03;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
        }
        
        .header-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .header-btn:hover { background: var(--border); }
        
        .social-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 1rem;
        }
        
        .social-link:hover { color: var(--accent); }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            text-align: center;
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Category Bar (Horizontal) */
        .category-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .category-bar::-webkit-scrollbar { height: 4px; }
        .category-bar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        
        .category-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-right: 0.5rem;
        }
        
        .category-chip {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        
        .category-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .category-chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .category-chip .count {
            margin-left: 0.25rem;
            opacity: 0.7;
            font-size: 0.75rem;
        }
        
        /* Trending Section */
        .trending-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .trending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .trending-title {
            font-weight: 600;
            font-size: 0.9375rem;
        }
        
        .trending-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .clear-btn {
            font-size: 0.8125rem;
            padding: 0.375rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            display: none;
        }
        
        .clear-btn.visible { display: block; }
        .clear-btn:hover { background: var(--border); }
        
        .trending-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .topic-pill {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
        }
        
        .topic-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .topic-pill.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .topic-pill.crisis {
            background: var(--critical-bg);
            border-color: var(--critical);
            color: var(--critical);
        }
        
        .topic-count {
            margin-left: 0.375rem;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Topic Deep Dive */
        .topic-dive {
            background: var(--accent-light);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .topic-dive.active { display: block; }
        
        .topic-dive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .topic-dive-title {
            font-weight: 600;
            color: var(--accent);
        }
        
        .topic-dive-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .topic-briefing {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .source-perspectives {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .source-perspective {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.75rem;
        }
        
        .source-name {
            font-weight: 600;
            font-size: 0.8125rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        
        .source-article {
            display: block;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.375rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .source-article:last-child { border-bottom: none; }
        .source-article:hover { color: var(--accent); }
        
        /* Filters Bar */
        .filters-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .filter-btn {
            padding: 0.375rem 0.625rem;
            font-size: 0.8125rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        
        .filter-btn:hover { border-color: var(--accent); }
        
        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .search-box {
            flex: 1;
            min-width: 150px;
            max-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .results-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .sort-select {
            padding: 0.375rem 0.625rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8125rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        /* Articles */
        .category-section {
            margin-bottom: 2rem;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 1rem;
        }
        
        .category-name {
            font-weight: 600;
            color: var(--accent);
        }
        
        .category-count {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }
        
        .article-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--medium);
            position: relative;
        }
        
        .article-card.critical { border-left-color: var(--critical); }
        .article-card.high { border-left-color: var(--high); }
        
        .article-priority-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            background: var(--critical);
            color: white;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .article-title {
            display: block;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .article-title:hover { color: var(--accent); }
        
        .article-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .article-source { color: var(--accent); }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 2rem 0;
            flex-wrap: wrap;
        }
        
        .page-btn {
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .page-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0 0.5rem;
        }
        
        /* PDF Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        
        .modal.visible { opacity: 1; visibility: visible; }
        
        .modal-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 450px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .modal-body {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .modal-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .modal-btn:hover { opacity: 0.9; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        /* Footer */
        footer {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        footer a {
            color: var(--text-secondary);
            text-decoration: none;
            margin: 0 0.75rem;
        }
        
        footer a:hover { color: var(--accent); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-stats { display: none; }
            .stats-bar { justify-content: center; }
            .stat-card { flex: 1; min-width: 70px; padding: 0.75rem; }
            .stat-value { font-size: 1.25rem; }
            .articles-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo">üì° PolicyRadar</a>
            <div class="header-stats">
                <span id="articleCount">- articles</span>
                <span id="lastUpdated">Updated: -</span>
            </div>
            <div class="header-actions">
                <a href="https://twitter.com/PolicyRadarIN" class="social-link" target="_blank">ùïè</a>
                <a href="https://linkedin.com/company/policyradarin" class="social-link" target="_blank">in</a>
                <button class="header-btn" onclick="showPdfModal()" title="Export PDF">üìÑ</button>
                <button class="header-btn" onclick="toggleTheme()" title="Toggle theme">üåô</button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCritical">-</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statHigh">-</div>
                <div class="stat-label">High</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statSources">-</div>
                <div class="stat-label">Sources</div>
            </div>
        </div>
        
        <!-- Category Bar (Horizontal) -->
        <div class="category-bar" id="categoryBar">
            <span class="category-label">üìÇ Categories:</span>
        </div>
        
        <!-- Trending Topics -->
        <div class="trending-section" id="trendingSection">
            <div class="trending-header">
                <div>
                    <div class="trending-title">üî• Trending Topics</div>
                    <div class="trending-subtitle">Click to explore coverage from multiple sources</div>
                </div>
                <button class="clear-btn" id="clearTopicBtn" onclick="clearTopicFilter()">Clear</button>
            </div>
            <div class="trending-pills" id="trendingPills"></div>
        </div>
        
        <!-- Topic Deep Dive -->
        <div class="topic-dive" id="topicDive">
            <div class="topic-dive-header">
                <div class="topic-dive-title" id="topicDiveTitle">üì∞ Coverage Analysis</div>
                <button class="topic-dive-close" onclick="closeTopicDive()">‚úï Close</button>
            </div>
            <div class="topic-briefing" id="topicBriefing"></div>
            <div class="source-perspectives" id="sourcePerspectives"></div>
        </div>
        
        <!-- Filters -->
        <div class="filters-bar">
            <div class="filters-row">
                <div class="filter-group">
                    <span class="filter-label">Time:</span>
                    <button class="filter-btn" data-filter="time" data-value="today">Today</button>
                    <button class="filter-btn active" data-filter="time" data-value="week">Week</button>
                    <button class="filter-btn" data-filter="time" data-value="month">Month</button>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Priority:</span>
                    <button class="filter-btn active" data-filter="priority" data-value="all">All</button>
                    <button class="filter-btn" data-filter="priority" data-value="critical">üî¥ Critical</button>
                    <button class="filter-btn" data-filter="priority" data-value="high">üü° High+</button>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search articles...">
                </div>
            </div>
        </div>
        
        <div class="results-summary">
            <span id="resultsCount">Showing 0 articles</span>
            <select class="sort-select" id="sortSelect">
                <option value="relevance">Sort: Relevance</option>
                <option value="recent">Sort: Most Recent</option>
            </select>
        </div>
        
        <div id="articlesContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem;">Loading policy intelligence...</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>
    
    <!-- PDF Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-box">
            <div class="modal-title">üìÑ Export Policy Report</div>
            <div class="modal-body">
                Download today's policy updates as a PDF with source links, categories, and priority levels.
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
                    Includes <strong id="pdfCount">0</strong> articles based on current filters.
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closePdfModal()">Cancel</button>
                <button class="modal-btn primary" onclick="downloadPdf()">Download PDF</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>¬© 2025 PolicyRadar. Made with ‚ù§Ô∏è for Indian democracy.</p>
        <div style="margin-top: 0.5rem;">
            <a href="https://twitter.com/PolicyRadarIN">Twitter</a>
            <a href="https://linkedin.com/company/policyradarIN">LinkedIn</a>
            <a href="mailto:roma@policyradar.in">Contact</a>
            <a href="https://xqea5xkp.forms.app/untitled-form">Feedback</a>
        </div>
    </footer>
    
    <script>
        // =====================
        // State
        // =====================
        let allArticles = [];
        let trendingTopics = [];
        let filteredArticles = [];
        let currentPage = 1;
        const pageSize = 30;
        
        const filters = {
            time: 'week',
            priority: 'all',
            category: null,
            topic: null,
            search: ''
        };
        
        const crisisKeywords = [
            'mea advisory', 'travel advisory', 'crisis', 'strikes', 'attack',
            'war', 'conflict', 'emergency', 'evacuate', 'stranded', 'indians abroad',
            'venezuela', 'ukraine', 'israel', 'iran', 'syria', 'bangladesh', 'global crisis'
        ];
        
        const categoryOrder = {
            'Constitutional & Legal': 10,
            'Economic Policy': 9,
            'Foreign Policy': 8,
            'Defence & Security': 7,
            'Technology Policy': 6,
            'Healthcare Policy': 5,
            'Environmental Policy': 4,
            'Education Policy': 3,
            'Social Policy': 2,
            'Governance & Administration': 1
        };
        
        // =====================
        // Initialization
        // =====================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initFilters();
            loadData();
        });
        
        // =====================
        // Data Loading
        // =====================
        async function loadData() {
            try {
                const response = await fetch('data/public_data.json');
                const data = await response.json();
                
                allArticles = data.articles || [];
                trendingTopics = data.trending_topics || [];
                
                updateStats();
                updateLastUpdated(data.last_updated);
                renderCategories();
                renderTrendingTopics();
                applyFilters();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('articlesContainer').innerHTML = 
                    '<div class="empty-state">‚ö†Ô∏è Error loading data. Please refresh.</div>';
            }
        }
        
        // =====================
        // Stats
        // =====================
        function updateStats() {
            const sources = new Set(allArticles.map(a => a.source_name));
            document.getElementById('statTotal').textContent = allArticles.length;
            document.getElementById('statCritical').textContent = 
                allArticles.filter(a => getPriorityClass(a) === 'critical').length;
            document.getElementById('statHigh').textContent = 
                allArticles.filter(a => getPriorityClass(a) === 'high').length;
            document.getElementById('statSources').textContent = sources.size;
            document.getElementById('articleCount').textContent = `${allArticles.length} articles`;
        }
        
        function updateLastUpdated(timestamp) {
            if (!timestamp) return;
            const date = new Date(timestamp);
            document.getElementById('lastUpdated').textContent = 
                `Updated: ${date.toLocaleDateString('en-IN', {
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                })}`;
        }
        
        function getPriorityClass(article) {
            const score = article.relevance_score || 0;
            if (score >= 0.6) return 'critical';
            if (score >= 0.4) return 'high';
            return 'medium';
        }
        
        // =====================
        // Categories
        // =====================
        function renderCategories() {
            const counts = {};
            allArticles.forEach(a => {
                const cat = a.category || 'Policy News';
                counts[cat] = (counts[cat] || 0) + 1;
            });
            
            const container = document.getElementById('categoryBar');
            const sorted = Object.entries(counts)
                .sort(([a], [b]) => (categoryOrder[b] || 0) - (categoryOrder[a] || 0));
            
            container.innerHTML = `
                <span class="category-label">üìÇ Categories:</span>
                <span class="category-chip ${!filters.category ? 'active' : ''}" 
                      onclick="filterByCategory(null)">All<span class="count">${allArticles.length}</span></span>
                ${sorted.map(([cat, count]) => `
                    <span class="category-chip ${filters.category === cat ? 'active' : ''}" 
                          onclick="filterByCategory('${cat.replace(/'/g, "\\'")}')">${cat}<span class="count">${count}</span></span>
                `).join('')}
            `;
        }
        
        function filterByCategory(cat) {
            filters.category = cat;
            currentPage = 1;
            renderCategories();
            applyFilters();
        }
        
        // =====================
        // Trending Topics
        // =====================
        function isCrisisTopic(name) {
            const lower = name.toLowerCase();
            return crisisKeywords.some(kw => lower.includes(kw));
        }
        
        function renderTrendingTopics() {
            const container = document.getElementById('trendingPills');
            
            if (!trendingTopics || trendingTopics.length === 0) {
                document.getElementById('trendingSection').style.display = 'none';
                return;
            }
            
            document.getElementById('trendingSection').style.display = 'block';
            
            // Sort: crisis first, then by count
            const sorted = [...trendingTopics].sort((a, b) => {
                const aCrisis = isCrisisTopic(a.topic);
                const bCrisis = isCrisisTopic(b.topic);
                if (aCrisis && !bCrisis) return -1;
                if (!aCrisis && bCrisis) return 1;
                return b.count - a.count;
            });
            
            container.innerHTML = sorted.map(t => {
                const crisis = isCrisisTopic(t.topic);
                const active = filters.topic === t.topic;
                let cls = 'topic-pill';
                if (active) cls += ' active';
                else if (crisis) cls += ' crisis';
                
                return `
                    <div class="${cls}" onclick="filterByTopic('${t.topic.replace(/'/g, "\\'")}')">
                        ${crisis ? 'üö® ' : ''}${t.topic}<span class="topic-count">${t.count}</span>
                    </div>
                `;
            }).join('');
        }
        
        function filterByTopic(name) {
            if (filters.topic === name) {
                filters.topic = null;
                document.getElementById('clearTopicBtn').classList.remove('visible');
                closeTopicDive();
            } else {
                filters.topic = name;
                document.getElementById('clearTopicBtn').classList.add('visible');
                showTopicDive(name);
            }
            currentPage = 1;
            renderTrendingTopics();
            applyFilters();
        }
        
        function clearTopicFilter() {
            filters.topic = null;
            document.getElementById('clearTopicBtn').classList.remove('visible');
            closeTopicDive();
            currentPage = 1;
            renderTrendingTopics();
            applyFilters();
        }
        
        function showTopicDive(topicName) {
            const topicData = trendingTopics.find(t => t.topic === topicName);
            if (!topicData || !topicData.articles) return;
            
            const articles = topicData.articles;
            const sources = [...new Set(articles.map(a => a.source || a.source_name || 'Unknown'))];
            
            document.getElementById('topicDiveTitle').textContent = `üì∞ ${topicName} - Multi-Source Analysis`;
            
            const crisis = isCrisisTopic(topicName);
            let brief = crisis 
                ? `‚ö†Ô∏è <strong>Developing Situation:</strong> This topic is receiving significant coverage across ${sources.length} sources. Monitor official advisories for updates.`
                : `This topic is being covered by ${sources.length} different sources with ${articles.length} total articles.`;
            brief += `<br><br><strong>Sources:</strong> ${sources.join(', ')}`;
            document.getElementById('topicBriefing').innerHTML = brief;
            
            // Group by source
            const bySource = {};
            articles.forEach(a => {
                const src = a.source || a.source_name || 'Unknown';
                if (!bySource[src]) bySource[src] = [];
                bySource[src].push(a);
            });
            
            document.getElementById('sourcePerspectives').innerHTML = Object.entries(bySource)
                .sort(([,a], [,b]) => b.length - a.length)
                .slice(0, 4)
                .map(([source, arts]) => `
                    <div class="source-perspective">
                        <div class="source-name">${source} (${arts.length})</div>
                        <div class="source-articles">
                            ${arts.slice(0, 3).map(a => `
                                <a href="${a.url}" target="_blank" class="source-article">${a.title}</a>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            
            document.getElementById('topicDive').classList.add('active');
        }
        
        function closeTopicDive() {
            document.getElementById('topicDive').classList.remove('active');
        }
        
        // =====================
        // Filters
        // =====================
        function initFilters() {
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    const value = btn.dataset.value;
                    
                    document.querySelectorAll(`.filter-btn[data-filter="${filter}"]`)
                        .forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    filters[filter] = value;
                    currentPage = 1;
                    applyFilters();
                });
            });
            
            document.getElementById('searchInput').addEventListener('input', e => {
                filters.search = e.target.value;
                currentPage = 1;
                applyFilters();
            });
            
            document.getElementById('sortSelect').addEventListener('change', () => {
                currentPage = 1;
                applyFilters();
            });
        }
        
        function applyFilters() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            filteredArticles = allArticles.filter(a => {
                // Time filter
                const pubDate = new Date(a.publication_date);
                if (filters.time === 'today' && pubDate < today) return false;
                if (filters.time === 'week') {
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (pubDate < weekAgo) return false;
                }
                if (filters.time === 'month') {
                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (pubDate < monthAgo) return false;
                }
                
                // Priority filter
                if (filters.priority !== 'all') {
                    const p = getPriorityClass(a);
                    if (filters.priority === 'critical' && p !== 'critical') return false;
                    if (filters.priority === 'high' && p === 'medium') return false;
                }
                
                // Category filter
                if (filters.category && a.category !== filters.category) return false;
                
                // Search filter
                if (filters.search) {
                    const s = filters.search.toLowerCase();
                    if (!a.title.toLowerCase().includes(s) && 
                        !a.source_name.toLowerCase().includes(s) &&
                        !(a.category || '').toLowerCase().includes(s)) return false;
                }
                
                // Topic filter - USE URL MATCHING (not text search!)
                if (filters.topic) {
                    const topic = trendingTopics.find(t => t.topic === filters.topic);
                    if (topic && topic.articles) {
                        const urls = new Set(topic.articles.map(x => x.url));
                        if (!urls.has(a.url)) return false;
                    }
                }
                
                return true;
            });
            
            // Sort
            const sortBy = document.getElementById('sortSelect').value;
            if (sortBy === 'relevance') {
                filteredArticles.sort((a, b) => (b.relevance_score || 0) - (a.relevance_score || 0));
            } else {
                filteredArticles.sort((a, b) => new Date(b.publication_date) - new Date(a.publication_date));
            }
            
            document.getElementById('resultsCount').textContent = `Showing ${filteredArticles.length} articles`;
            renderArticles();
            renderPagination();
        }
        
        // =====================
        // Render Articles
        // =====================
        function renderArticles() {
            const container = document.getElementById('articlesContainer');
            
            // Paginate
            const startIdx = (currentPage - 1) * pageSize;
            const pageArticles = filteredArticles.slice(startIdx, startIdx + pageSize);
            
            if (pageArticles.length === 0) {
                container.innerHTML = '<div class="empty-state">üîç No articles match your filters.</div>';
                return;
            }
            
            // Group by category
            const grouped = {};
            pageArticles.forEach(a => {
                const cat = a.category || 'Policy News';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(a);
            });
            
            container.innerHTML = Object.entries(grouped)
                .sort(([a], [b]) => (categoryOrder[b] || 0) - (categoryOrder[a] || 0))
                .map(([cat, arts]) => `
                    <section class="category-section">
                        <div class="category-header">
                            <span class="category-name">${cat}</span>
                            <span class="category-count">${arts.length} articles</span>
                        </div>
                        <div class="articles-grid">
                            ${arts.map(a => {
                                const priority = getPriorityClass(a);
                                const badge = priority === 'critical' ? 
                                    '<span class="article-priority-badge">Critical</span>' : '';
                                return `
                                    <article class="article-card ${priority}">
                                        ${badge}
                                        <a href="${a.url}" target="_blank" class="article-title">${escapeHtml(a.title)}</a>
                                        <div class="article-meta">
                                            <span class="article-source">${escapeHtml(a.source_name)}</span>
                                            <span>${formatDate(a.publication_date)}</span>
                                        </div>
                                    </article>
                                `;
                            }).join('')}
                        </div>
                    </section>
                `).join('');
        }
        
        // =====================
        // Pagination
        // =====================
        function renderPagination() {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredArticles.length / pageSize);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" 
                          ${currentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;
            
            // Show page numbers
            const maxVisible = 5;
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
            
            if (start > 1) {
                html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (start > 2) html += `<span class="page-info">...</span>`;
            }
            
            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                          onclick="goToPage(${i})">${i}</button>`;
            }
            
            if (end < totalPages) {
                if (end < totalPages - 1) html += `<span class="page-info">...</span>`;
                html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" 
                      ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
            
            container.innerHTML = html;
        }
        
        function goToPage(page) {
            const totalPages = Math.ceil(filteredArticles.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderArticles();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // =====================
        // Theme
        // =====================
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }
        
        // =====================
        // PDF Export
        // =====================
        function showPdfModal() {
            document.getElementById('pdfCount').textContent = filteredArticles.length;
            document.getElementById('pdfModal').classList.add('visible');
        }
        
        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('visible');
        }
        
        function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const articles = filteredArticles;
            const today = new Date().toLocaleDateString('en-IN', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(37, 99, 235);
            doc.text('PolicyRadar Daily Briefing', 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(today + ' | ' + articles.length + ' articles', 20, 28);
            doc.text('policyradar.in', 20, 34);
            
            let y = 45;
            const margin = 15;
            const pageWidth = 180;
            const pageHeight = 280;
            
            // Group by category
            const byCategory = {};
            articles.forEach(a => {
                const cat = a.category || 'Policy News';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(a);
            });
            
            for (const [category, catArticles] of Object.entries(byCategory)) {
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = 20;
                }
                
                // Category header
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(37, 99, 235);
                doc.text(category, margin, y);
                doc.setFont(undefined, 'normal');
                y += 7;
                
                for (const article of catArticles.slice(0, 25)) {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Priority bullet
                    const priority = getPriorityClass(article);
                    if (priority === 'critical') {
                        doc.setTextColor(220, 53, 69);
                        doc.text('‚óè', margin, y);
                    } else if (priority === 'high') {
                        doc.setTextColor(245, 158, 11);
                        doc.text('‚óè', margin, y);
                    } else {
                        doc.setTextColor(16, 185, 129);
                        doc.text('‚óã', margin, y);
                    }
                    
                    // Title
                    doc.setFontSize(9);
                    doc.setTextColor(30);
                    const titleLines = doc.splitTextToSize(article.title, pageWidth - 10);
                    doc.text(titleLines, margin + 5, y);
                    y += titleLines.length * 4;
                    
                    // Source and date
                    doc.setFontSize(7);
                    doc.setTextColor(100);
                    doc.text(`${article.source_name} | ${formatDate(article.publication_date)}`, margin + 5, y);
                    y += 3.5;
                    
                    // URL as clickable link
                    doc.setTextColor(37, 99, 235);
                    const urlText = article.url.length > 80 ? article.url.substring(0, 77) + '...' : article.url;
                    doc.text(urlText, margin + 5, y);
                    // Add clickable link area
                    const textWidth = doc.getTextWidth(urlText);
                    doc.link(margin + 5, y - 2.5, textWidth, 3.5, { url: article.url });
                    y += 6;
                }
                
                y += 4;
            }
            
            // Footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(150);
                doc.text(`PolicyRadar | policyradar.in | Page ${i} of ${pageCount}`, margin, 290);
            }
            
            doc.save(`PolicyRadar_${new Date().toISOString().split('T')[0]}.pdf`);
            closePdfModal();
        }
        
        // =====================
        // Utilities
        // =====================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const now = new Date();
            const days = Math.floor((now - d) / (1000 * 60 * 60 * 24));
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;
            return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        }
        
        // Modal close handlers
        document.getElementById('pdfModal').addEventListener('click', e => {
            if (e.target.id === 'pdfModal') closePdfModal();
        });
        
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closePdfModal();
        });
    </script>
</body>
</html>
