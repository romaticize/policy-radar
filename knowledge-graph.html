<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyRadar - Knowledge Graph</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-primary: #fafbfc;
            --bg-secondary: #f0f2f5;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --accent-primary: #4f46e5;
            --accent-light: #eef2ff;
            --accent-hover: #4338ca;
            --success: #059669;
            --warning: #d97706;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --graph-bg: linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f0fdf4 100%);
            --node-glow: 0 0 20px rgba(79, 70, 229, 0.15);
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #1e1e32;
            --bg-elevated: #252542;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --border-color: #374151;
            --border-light: #1f2937;
            --accent-primary: #818cf8;
            --accent-light: rgba(129, 140, 248, 0.1);
            --accent-hover: #a5b4fc;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --graph-bg: linear-gradient(135deg, #0f0f1a 0%, #1a1a3e 50%, #0f1a1a 100%);
            --node-glow: 0 0 30px rgba(129, 140, 248, 0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            padding: 0 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), #7c3aed);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-md);
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            border: 1px solid transparent;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border-color);
        }
        
        .btn-ghost:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
            font-size: 1rem;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            gap: 2px;
        }
        
        .nav-tab {
            padding: 8px 16px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }
        
        .nav-tab.active {
            color: var(--accent-primary);
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
        }
        
        .divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }
        
        /* Graph Container */
        #graph-container {
            width: 100vw;
            height: 100vh;
            padding-top: 64px;
            background: var(--graph-bg);
        }
        
        /* Nodes */
        .node { cursor: pointer; }
        
        .node circle {
            stroke: var(--bg-card);
            stroke-width: 3px;
            transition: all 0.25s ease;
        }
        
        .node:hover circle {
            stroke-width: 4px;
            filter: drop-shadow(var(--node-glow));
            transform: scale(1.05);
        }
        
        .node.selected circle {
            stroke: var(--accent-primary);
            stroke-width: 5px;
            filter: drop-shadow(var(--node-glow));
        }
        
        .node text {
            fill: var(--text-primary);
            pointer-events: none;
            font-weight: 600;
            font-size: 10px;
        }
        
        .node text.label-category {
            fill: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .node text.label-keyword {
            text-shadow: 
                0 0 8px var(--bg-primary),
                0 0 16px var(--bg-primary),
                2px 2px 4px var(--bg-primary),
                -2px -2px 4px var(--bg-primary);
        }
        
        .link {
            stroke: var(--border-color);
            stroke-opacity: 0.3;
            transition: all 0.25s ease;
        }
        
        .link.highlighted {
            stroke: var(--accent-primary);
            stroke-opacity: 0.6;
            stroke-width: 2.5px;
        }
        
        /* Legend Panel */
        .legend {
            position: fixed;
            top: 84px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 50;
            min-width: 180px;
        }
        
        .legend-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
        
        .legend-divider {
            height: 1px;
            background: var(--border-color);
            margin: 14px 0;
        }
        
        .legend-size {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .legend-size-dot {
            border-radius: 50%;
            background: var(--accent-primary);
            opacity: 0.5;
        }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 340px;
            max-height: 55vh;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            display: none;
            z-index: 50;
            box-shadow: var(--shadow-lg);
        }
        
        .info-panel.visible { display: block; }
        
        .info-panel-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .info-panel-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .info-panel-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        .info-panel-body {
            padding: 16px 20px 20px;
            overflow-y: auto;
            max-height: calc(55vh - 80px);
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section:last-child { margin-bottom: 0; }
        
        .info-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .keyword-tag {
            display: inline-block;
            padding: 5px 10px;
            background: var(--accent-light);
            color: var(--accent-primary);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .keyword-tag:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-1px);
        }
        
        .article-card {
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .article-card:hover {
            background: var(--bg-elevated);
            box-shadow: var(--shadow-sm);
        }
        
        .article-card:last-child { margin-bottom: 0; }
        
        .article-source {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .article-title {
            font-size: 0.8125rem;
            font-weight: 500;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .article-title a {
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .article-title a:hover { color: var(--accent-primary); }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 16px;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .loading-text {
            font-size: 0.9375rem;
            color: var(--text-secondary);
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Tooltip */
        .tooltip {
            position: fixed;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            color: var(--text-primary);
        }
        
        .tooltip.visible { opacity: 1; }
        
        .tooltip-count {
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 6px;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Building knowledge graph...</div>
    </div>
    
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">üï∏Ô∏è</div>
                <span>Knowledge Graph</span>
            </div>
        </div>
        
        <div class="header-controls">
            <button class="btn btn-ghost btn-icon" onclick="toggleTheme()" title="Toggle theme">üåì</button>
            <button class="btn btn-ghost" onclick="resetZoom()">‚Üª Reset View</button>
            <button class="btn btn-ghost" onclick="togglePhysics()" id="physics-btn">‚è∏ Pause</button>
            <div class="divider"></div>
            <nav class="nav-tabs">
                <a href="index.html" class="nav-tab">üìä Dashboard</a>
                <a href="topic-explorer.html" class="nav-tab">üî≠ Explorer</a>
                <a href="knowledge-graph.html" class="nav-tab active">üï∏Ô∏è Graph</a>
            </nav>
        </div>
    </header>
    
    <div class="legend">
        <div class="legend-title">Node Types</div>
        <div class="legend-item"><div class="legend-dot" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);"></div> Category</div>
        <div class="legend-item"><div class="legend-dot" style="background: #059669;"></div> High frequency (10+)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #d97706;"></div> Medium (5-9)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #9ca3af;"></div> Low (3-4)</div>
        <div class="legend-divider"></div>
        <div class="legend-size">
            <div class="legend-size-dot" style="width: 10px; height: 10px;"></div>
            <span>‚Üí</span>
            <div class="legend-size-dot" style="width: 24px; height: 24px;"></div>
            <span>Frequency</span>
        </div>
    </div>
    
    <div id="graph-container"></div>
    
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header">
            <div class="info-panel-title" id="panel-title">-</div>
            <div class="info-panel-meta" id="panel-meta">-</div>
        </div>
        <div class="info-panel-body">
            <div class="info-section">
                <div class="info-section-title">Related Keywords</div>
                <div class="keyword-tags" id="panel-keywords"></div>
            </div>
            <div class="info-section">
                <div class="info-section-title">Sample Articles</div>
                <div id="panel-articles"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        const CONFIG = { dataUrl: 'data/public_data.json' };
        
        // Beautiful distinct category colors
        const CATEGORY_COLORS = {
            'Economic Policy': '#3b82f6',
            'Trade & Industry': '#8b5cf6',
            'Constitutional & Legal': '#ec4899',
            'Technology Policy': '#06b6d4',
            'Healthcare Policy': '#10b981',
            'Defence & Security': '#f97316',
            'Governance & Administration': '#ef4444',
            'Politics': '#f43f5e',
            'Education Policy': '#0ea5e9',
            'Environmental Policy': '#22c55e',
            'Infrastructure & Transport': '#a855f7',
            'Agricultural Policy': '#84cc16',
            'Energy Policy': '#eab308',
            'Foreign Policy': '#6366f1',
            'Consumer Affairs': '#d946ef',
            'Policy News': '#64748b'
        };
        
        // Comprehensive stop words
        const STOP_WORDS = new Set([
            'the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','as','is','was',
            'are','were','be','been','being','have','has','had','do','does','did','will','would','could','should',
            'may','might','must','shall','can','that','this','these','those','it','its','they','them','their',
            'he','him','his','she','her','we','us','our','you','your','who','whom','which','what','where','when',
            'why','how','all','each','every','both','few','more','most','other','some','such','no','nor','not',
            'only','own','same','so','than','too','very','just','also','now','here','there','then','once','if',
            'unless','until','while','although','though','because','since','after','before','during','about',
            'into','through','above','below','up','down','out','off','over','under','again','further','any','another',
            'says','said','saying','say','told','tell','tells','according','report','reports','reported',
            'reporting','news','latest','update','updates','updated','announces','announced','reveals','revealed',
            'unveils','unveiled','launches','launched','introduces','introduced','proposes','proposed','seeks',
            'sought','plans','planned','planning','aims','aimed','targets','claims','claimed','alleges','alleged',
            'suggests','suggested','warns','warned','notes','noted','adds','added','states','stated','confirms',
            'confirmed','denies','denied','admits','admitted','argues','argued','believes','believed','considers',
            'considered','expects','expected','hopes','hoped','fears','feared','demands','demanded','urges','urged',
            'calls','called','asks','asked','requests','requested','orders','ordered','directs','directed',
            'releases','released','passes','passed','approves','approved','imposes','imposed','delivers','delivered',
            'clears','cleared','reviews','reviewed','upholds','upheld','defers','deferred','likely','unlikely',
            'get','gets','got','getting','make','makes','made','making','take','takes','took','taken','taking',
            'come','comes','came','coming','go','goes','went','gone','going','know','knows','knew','known',
            'think','thinks','thought','see','sees','saw','seen','want','wants','wanted','use','uses','used',
            'using','find','finds','found','give','gives','gave','given','put','puts','keep','keeps','kept',
            'let','lets','begin','begins','began','set','sets','setting','show','shows','showed','shown',
            'move','moves','moved','bring','brings','brought','turn','turns','turned','start','starts','started',
            'run','runs','running','meet','meets','met','pay','pays','paid','hear','hears','heard','play','plays',
            'invest','invests','invested','investing',
            'year','years','month','months','week','weeks','day','days','today','yesterday','tomorrow','time',
            'times','hour','hours','first','last','next','previous','current','recent','recently','early','late',
            'soon','later','earlier','already','still','yet','ever','never','always','often','sometimes','usually',
            'daily','weekly','monthly','yearly','annual','quarterly','winter','summer','spring','autumn',
            'january','february','march','april','may','june','july','august','september','october','november','december',
            'one','two','three','four','five','six','seven','eight','nine','ten','hundred','thousand','million',
            'billion','crore','lakh','percent','percentage','half','quarter','double','triple','single','multiple',
            'several','many','much','few','little','less','least',
            'big','small','large','huge','tiny','great','good','better','best','bad','worse','worst','old','new',
            'young','high','low','higher','lower','highest','lowest','major','minor','main','key','important',
            'significant','critical','crucial','essential','primary','secondary','special','general','specific',
            'particular','certain','various','different','similar','same','other','full','empty','complete','total',
            'entire','whole','partial','final','initial','basic','simple','complex','easy','hard','difficult',
            'possible','impossible','necessary','available','ready','clear','strong','weak','fast','slow','quick',
            'rapid','successful','successfully','landmark',
            'india','indian','indians','country','countries','nation','national','state','states','central',
            'government','govt','minister','ministers','ministry','ministries','official','officials',
            'authority','authorities','department','departments','public','private','federal','union',
            'people','person','persons','citizen','citizens','resident','residents','population',
            'leader','leaders','chief','head','heads','board','boards','council','councils','committee',
            'committees','commission','commissions','agency','agencies','body','bodies','unit','units',
            'office','offices','cabinet','parliament','centre','election','elections',
            'court','courts','supreme','bench','justice','judge','judges','case','cases','order','orders',
            'petition','petitions','plea','pleas','hearing','hearings','verdict','verdicts','ruling','rulings',
            'law','laws','legal','illegal','act','acts','section','sections','rule','rules','regulation',
            'regulations','policy','policies','bill','bills','amendment','amendments','notice','notices',
            'circular','notification','guideline','guidelines','norm','norms','compliance','violation',
            'violations','penalty','penalties','fine','fines','judgment','judgments','validity','defence','defense',
            'company','companies','firm','firms','corporate','corporation','business','businesses','industry',
            'industries','sector','sectors','market','markets','share','shares','stock','stocks','price','prices',
            'cost','costs','rate','rates','value','values','growth','profit','profits','loss','losses','revenue',
            'revenues','income','expense','expenses','sales','sale','deal','deals','trade','trades','trading',
            'investment','investments','investor','investors','fund','funds','funding','finance','financial',
            'fiscal','economic','economy','economies','budget','budgets','tax','taxes','taxation','bank','banks',
            'banking','loan','loans','credit','credits','debt','debts','asset','assets','liability','capital',
            'quarter','quarters','targets','levels','threshold','breach','revision',
            'action','actions','issue','issues','matter','matters','part','parts','place','places','point','points',
            'way','ways','end','ends','help','helps','need','needs','face','hand','life','home','house','water',
            'food','money','power','powers','group','groups','member','members','team','teams','system','systems',
            'level','area','areas','region','regions','zone','zones','line','lines','number','numbers','word',
            'words','name','names','type','types','kind','kinds','form','forms','fact','facts','result','results',
            'effect','effects','impact','impacts','reason','reasons','cause','causes','problem','problems',
            'solution','solutions','question','questions','answer','answers','idea','ideas','plan','plans',
            'project','projects','program','programs','scheme','schemes','initiative','initiatives','measure',
            'measures','step','steps','effort','efforts','attempt','attempts','work','works','job','jobs','task',
            'tasks','role','roles','position','positions','post','posts','situation','situations','condition',
            'conditions','status','example','examples','instance','instances','event','events','incident',
            'incidents','development','developments','progress','process','processes','procedure','procedures',
            'method','methods','approach','approaches','strategy','strategies','option','options','choice',
            'choices','decision','decisions','agreement','agreements','contract','contracts','meeting','meetings',
            'conference','conferences','session','sessions','summit','summits','talk','talks','discussion',
            'discussions','debate','debates','review','reviews','study','studies','research','survey','surveys',
            'analysis','data','information','detail','details','record','records','document','documents','file',
            'files','paper','papers','source','sources','reference','evidence','proof','basis','base','foundation',
            'support','benefit','benefits','advantage','opportunity','opportunities','challenge','challenges',
            'risk','risks','threat','threats','concern','concerns','interest','interests','attention','focus',
            'priority','priorities','target','goal','goals','objective','objectives','aim','aims','purpose',
            'view','views','opinion','opinions','statement','statements','comment','comments','response',
            'responses','reaction','reactions','message','messages','announcement','release','launch','opening',
            'closure','expansion','reforms','stricter','mutual','energy','fighter','waiver','mission','benefiting',
            'website','platform','application','software','technology','technologies','tech','digital','online',
            'internet','network','media','social','video','image','photo','content','user','account','page',
            'apple','google','amazon','facebook','twitter','microsoft','samsung',
            'thing','things','something','anything','everything','nothing','someone','anyone','everyone','nobody',
            'however','therefore','moreover','furthermore','nevertheless','meanwhile','otherwise','instead',
            'despite','regardless','whether','hence','thus','accordingly','consequently','subsequently',
            'previously','initially','finally','eventually','ultimately','basically','essentially','generally',
            'usually','normally','typically','actually','really','certainly','definitely','probably','possibly',
            'perhaps','maybe','obviously','clearly','apparently','evidently','presumably','supposedly','allegedly',
            'reportedly','based','given','considering','regarding','concerning','including','excluding','except',
            'besides','beyond','within','without','among','between','world','global','local','foreign','domestic',
            'international','regional','nationwide','security','safety','protection','rights','freedom',
            'increase','decrease','rise','decline','success','failure','achievement','victory','defeat',
            'crisis','emergency','disaster'
        ]);
        
        let simulation, physicsEnabled = true;
        
        function initTheme() {
            const saved = localStorage.getItem('policyradar-theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) 
                document.documentElement.setAttribute('data-theme', 'dark');
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('policyradar-theme', newTheme);
        }
        
        function extractKeywords(text) {
            const words = text.toLowerCase().match(/\b[a-z]{6,}\b/g) || [];
            return [...new Set(words.filter(w => !STOP_WORDS.has(w)))];
        }
        
        async function init() {
            initTheme();
            try {
                const response = await fetch(CONFIG.dataUrl);
                const data = await response.json();
                buildGraph(data.articles || []);
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('loading').innerHTML = '<p style="color: var(--text-muted);">Failed to load data</p>';
            }
        }
        
        function buildGraph(articles) {
            const nodes = [], links = [];
            const nodeMap = new Map();
            const keywordToArticles = new Map();
            const keywordToCategories = new Map();
            
            // Category nodes
            const categories = [...new Set(articles.map(a => a.category || 'Policy News'))];
            categories.forEach(cat => {
                const catArticles = articles.filter(a => (a.category || 'Policy News') === cat);
                const node = {
                    id: `cat_${cat}`, label: cat, type: 'category',
                    size: 38, color: CATEGORY_COLORS[cat] || '#64748b',
                    articles: catArticles
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });
            
            // Extract keywords
            articles.forEach(article => {
                const category = article.category || 'Policy News';
                extractKeywords(article.title).forEach(kw => {
                    if (!keywordToArticles.has(kw)) {
                        keywordToArticles.set(kw, []);
                        keywordToCategories.set(kw, new Set());
                    }
                    keywordToArticles.get(kw).push(article);
                    keywordToCategories.get(kw).add(category);
                });
            });
            
            // Top keywords
            const significantKeywords = [...keywordToArticles.entries()]
                .filter(([kw, arts]) => arts.length >= 3 && kw.length >= 6)
                .sort((a, b) => b[1].length - a[1].length)
                .slice(0, 50);
            
            const maxCount = significantKeywords[0]?.[1].length || 1;
            
            significantKeywords.forEach(([kw, arts]) => {
                const count = arts.length;
                let color = '#9ca3af';
                if (count >= 10) color = '#059669';
                else if (count >= 5) color = '#d97706';
                
                const ratio = count / maxCount;
                const size = 14 + ratio * 20;
                
                const node = {
                    id: `kw_${kw}`, label: kw, type: 'keyword',
                    size, color, articles: arts, count,
                    categories: [...keywordToCategories.get(kw)]
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
                
                keywordToCategories.get(kw).forEach(cat => {
                    links.push({ source: `cat_${cat}`, target: `kw_${kw}`, strength: 0.3 });
                });
            });
            
            // Co-occurrence links
            const kwPairs = new Map();
            articles.forEach(article => {
                const keywords = extractKeywords(article.title).filter(kw => nodeMap.has(`kw_${kw}`));
                for (let i = 0; i < keywords.length; i++) {
                    for (let j = i + 1; j < keywords.length; j++) {
                        const pair = [keywords[i], keywords[j]].sort().join('|');
                        kwPairs.set(pair, (kwPairs.get(pair) || 0) + 1);
                    }
                }
            });
            
            kwPairs.forEach((count, pair) => {
                if (count >= 2) {
                    const [kw1, kw2] = pair.split('|');
                    links.push({ source: `kw_${kw1}`, target: `kw_${kw2}`, strength: count / 5 });
                }
            });
            
            renderGraph(nodes, links);
        }
        
        function renderGraph(nodes, links) {
            const container = document.getElementById('graph-container');
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            
            const svg = d3.select('#graph-container').append('svg')
                .attr('width', width).attr('height', height);
            
            const zoom = d3.zoom()
                .scaleExtent([0.2, 3])
                .on('zoom', e => g.attr('transform', e.transform));
            svg.call(zoom);
            
            const g = svg.append('g');
            
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id)
                    .distance(d => (d.source.type === 'category' || d.target.type === 'category') ? 160 : 90)
                    .strength(d => d.strength || 0.3))
                .force('charge', d3.forceManyBody().strength(d => d.type === 'category' ? -600 : -120))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 10));
            
            const link = g.append('g').selectAll('line').data(links).join('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.max(1, d.strength * 2));
            
            const node = g.append('g').selectAll('g').data(nodes).join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
                .on('click', (e, d) => selectNode(d))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            node.append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => d.type === 'category' ? `url(#grad-${d.label.replace(/[^a-z]/gi, '')})` : d.color)
                .attr('opacity', 0.9);
            
            // Gradients for categories
            const defs = svg.append('defs');
            nodes.filter(n => n.type === 'category').forEach(n => {
                const grad = defs.append('linearGradient')
                    .attr('id', `grad-${n.label.replace(/[^a-z]/gi, '')}`)
                    .attr('x1', '0%').attr('y1', '0%').attr('x2', '100%').attr('y2', '100%');
                grad.append('stop').attr('offset', '0%').attr('stop-color', n.color);
                grad.append('stop').attr('offset', '100%').attr('stop-color', adjustColor(n.color, -30));
            });
            
            // Labels
            node.append('text')
                .text(d => {
                    if (d.type === 'category') {
                        const abbrevs = {
                            'Constitutional & Legal': 'Legal', 'Governance & Administration': 'Gov',
                            'Infrastructure & Transport': 'Infra', 'Trade & Industry': 'Trade',
                            'Economic Policy': 'Economy', 'Technology Policy': 'Tech',
                            'Healthcare Policy': 'Health', 'Defence & Security': 'Defence',
                            'Education Policy': 'Education', 'Environmental Policy': 'Environ',
                            'Agricultural Policy': 'Agri', 'Energy Policy': 'Energy',
                            'Foreign Policy': 'Foreign', 'Consumer Affairs': 'Consumer', 'Policy News': 'News'
                        };
                        return abbrevs[d.label] || d.label.split(' ')[0];
                    }
                    return d.label.length > 10 ? d.label.slice(0, 9) + '‚Ä¶' : d.label;
                })
                .attr('text-anchor', 'middle')
                .attr('class', d => d.type === 'category' ? 'label-category' : 'label-keyword')
                .attr('dy', d => d.type === 'category' ? 4 : -(d.size + 8))
                .style('font-size', d => d.type === 'category' ? '11px' : `${Math.max(9, 8 + (d.size - 14) / 4)}px`);
            
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            window.graphElements = { svg, g, node, link, zoom, nodes, links };
            document.getElementById('loading').classList.add('hidden');
        }
        
        function adjustColor(hex, amount) {
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }
        
        function selectNode(d) {
            const { node, link } = window.graphElements;
            node.classed('selected', n => n.id === d.id);
            link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
            
            const panel = document.getElementById('info-panel');
            panel.classList.add('visible');
            
            document.getElementById('panel-title').textContent = d.label;
            document.getElementById('panel-meta').textContent = 
                `${d.type === 'category' ? 'Category' : 'Keyword'} ‚Ä¢ ${d.articles.length} articles`;
            
            const relatedKws = new Set();
            if (d.type === 'keyword') {
                d.articles.forEach(a => extractKeywords(a.title).forEach(kw => {
                    if (kw !== d.label) relatedKws.add(kw);
                }));
            }
            
            const topRelated = [...relatedKws].slice(0, 10);
            document.getElementById('panel-keywords').innerHTML = topRelated.length > 0
                ? topRelated.map(kw => `<span class="keyword-tag" onclick="findNode('kw_${kw}')">${kw}</span>`).join('')
                : '<span style="color: var(--text-muted); font-size: 0.8125rem;">No related keywords</span>';
            
            document.getElementById('panel-articles').innerHTML = d.articles.slice(0, 4).map(a => `
                <div class="article-card">
                    <div class="article-source">${escapeHtml(a.source_name)}</div>
                    <div class="article-title"><a href="${escapeHtml(a.url)}" target="_blank">${escapeHtml(a.title)}</a></div>
                </div>
            `).join('');
        }
        
        function findNode(nodeId) {
            const { nodes, zoom, svg } = window.graphElements;
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                const width = document.getElementById('graph-container').offsetWidth;
                const height = document.getElementById('graph-container').offsetHeight;
                svg.transition().duration(750).call(zoom.transform, 
                    d3.zoomIdentity.translate(width/2, height/2).scale(1.5).translate(-node.x, -node.y));
                selectNode(node);
            }
        }
        
        function showTooltip(e, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `${d.label}<span class="tooltip-count">${d.articles.length} articles</span>`;
            tooltip.style.left = `${e.pageX + 12}px`;
            tooltip.style.top = `${e.pageY + 12}px`;
            tooltip.classList.add('visible');
        }
        
        function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }
        
        function resetZoom() {
            const { svg, zoom } = window.graphElements;
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.scale(0.85));
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            const btn = document.getElementById('physics-btn');
            if (physicsEnabled) { simulation.alpha(0.3).restart(); btn.textContent = '‚è∏ Pause'; }
            else { simulation.stop(); btn.textContent = '‚ñ∂ Resume'; }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        init();
    </script>
</body>
</html>
