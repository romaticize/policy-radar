<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyRadar Knowledge Graph</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0d17;
            --bg-secondary: #16131f;
            --bg-card: #1c1827;
            --bg-elevated: #231f30;
            --text-primary: #f4f4f6;
            --text-secondary: #a09fb1;
            --text-muted: #6c6a7e;
            --border-color: #2e2a3d;
            --accent-primary: #7c6aef;
            --accent-secondary: #9d8df7;
            --accent-glow: rgba(124, 106, 239, 0.25);
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
        }
        
        [data-theme="light"] {
            --bg-primary: #f8f9fc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-elevated: #f1f3f8;
            --text-primary: #1a1a2e;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.15);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            line-height: 1.5;
        }
        
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 52px;
            padding: 0 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: -0.01em;
        }
        
        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .header-controls { display: flex; gap: 6px; align-items: center; }
        
        .btn {
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn:hover {
            background: var(--accent-glow);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }
        
        .btn-icon { padding: 6px 8px; }
        
        #graph-container {
            width: 100vw;
            height: 100vh;
            padding-top: 52px;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, var(--accent-glow) 0%, transparent 25%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.08) 0%, transparent 25%);
        }
        
        .node { cursor: pointer; }
        
        .node circle {
            stroke: var(--bg-primary);
            stroke-width: 2px;
            transition: all 0.2s ease;
        }
        
        .node:hover circle {
            stroke-width: 3px;
            filter: brightness(1.12) drop-shadow(0 0 12px var(--accent-glow));
        }
        
        .node.selected circle {
            stroke: var(--accent-primary);
            stroke-width: 3px;
            filter: drop-shadow(0 0 16px var(--accent-glow));
        }
        
        .node.verified circle { stroke: var(--success); stroke-width: 3px; }
        
        .node text {
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            letter-spacing: -0.01em;
        }
        
        .link { stroke: var(--border-color); stroke-opacity: 0.2; }
        
        .link.highlighted {
            stroke: var(--accent-primary);
            stroke-opacity: 0.5;
            stroke-width: 2px;
        }
        
        .legend {
            position: fixed;
            top: 68px;
            right: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 14px;
            z-index: 50;
            min-width: 160px;
        }
        
        .legend-title {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 0;
            font-size: 0.6875rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .stats-bar {
            position: fixed;
            top: 68px;
            left: 16px;
            display: flex;
            gap: 12px;
            z-index: 50;
        }
        
        .stat-chip {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value { font-size: 0.875rem; font-weight: 700; color: var(--accent-primary); }
        .stat-label { font-size: 0.625rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
        
        .info-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            width: 320px;
            max-height: 50vh;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: none;
            z-index: 50;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .info-panel.visible { display: block; }
        
        .info-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-elevated);
        }
        
        .info-panel-title {
            font-size: 0.9375rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .verified-badge {
            background: var(--success);
            color: #000;
            font-size: 0.5625rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .info-panel-meta { font-size: 0.6875rem; color: var(--text-muted); margin-top: 2px; }
        
        .info-panel-body {
            padding: 14px 16px;
            overflow-y: auto;
            max-height: calc(50vh - 70px);
        }
        
        .info-section { margin-bottom: 14px; }
        
        .info-section-title {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .keyword-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        
        .keyword-tag {
            padding: 3px 8px;
            background: var(--accent-glow);
            color: var(--accent-primary);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .keyword-tag:hover { background: var(--accent-primary); color: white; }
        
        .article-card {
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid transparent;
        }
        
        .article-card.multi-source {
            border-left-color: var(--success);
            background: linear-gradient(90deg, rgba(52, 211, 153, 0.08), transparent);
        }
        
        .article-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .article-source {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .article-sources-count {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--success);
            background: rgba(52, 211, 153, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .article-title { font-size: 0.75rem; line-height: 1.4; }
        .article-title a { color: var(--text-primary); text-decoration: none; }
        .article-title a:hover { color: var(--accent-primary); }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        
        .loading-text { margin-top: 12px; font-size: 0.75rem; color: var(--text-muted); }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .tooltip {
            position: fixed;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.6875rem;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip.visible { opacity: 1; }
        
        .panel-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--bg-card);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .panel-close:hover { background: var(--accent-glow); color: var(--accent-primary); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Building knowledge graph...</div>
    </div>
    
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üï∏Ô∏è</div>
            <span>Knowledge Graph</span>
        </div>
        <div class="header-controls">
            <button class="btn btn-icon" onclick="resetZoom()" title="Reset View">‚ü≤</button>
            <button class="btn btn-icon" onclick="togglePhysics()" id="physics-btn" title="Toggle Physics">‚è∏</button>
            <button class="btn btn-icon" onclick="toggleTheme()" id="theme-btn" title="Toggle Theme">‚òÄÔ∏è</button>
            <a href="topic-explorer.html" class="btn">üî≠ Topics</a>
            <a href="index.html" class="btn btn-primary">‚Üê Dashboard</a>
        </div>
    </header>
    
    <div class="stats-bar" id="stats-bar">
        <div class="stat-chip">
            <span class="stat-value" id="stat-keywords">-</span>
            <span class="stat-label">Keywords</span>
        </div>
        <div class="stat-chip">
            <span class="stat-value" id="stat-verified">-</span>
            <span class="stat-label">Multi-Source</span>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-title">Node Types</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-primary);"></div> Category</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--success);"></div> High freq (5+)</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--warning);"></div> Medium (2-4)</div>
        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border-color);">
            <div class="legend-title">Verification</div>
            <div class="legend-item"><div class="legend-dot" style="background: var(--success); box-shadow: 0 0 8px var(--success);"></div> Multi-source</div>
        </div>
    </div>
    
    <div id="graph-container"></div>
    
    <div class="info-panel" id="info-panel">
        <button class="panel-close" onclick="closePanel()">‚úï</button>
        <div class="info-panel-header">
            <div class="info-panel-title" id="panel-title">-</div>
            <div class="info-panel-meta" id="panel-meta">-</div>
        </div>
        <div class="info-panel-body">
            <div class="info-section">
                <div class="info-section-title">Related Keywords</div>
                <div class="keyword-tags" id="panel-keywords"></div>
            </div>
            <div class="info-section">
                <div class="info-section-title">Articles</div>
                <div id="panel-articles"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        const CONFIG = { dataUrl: 'data/public_data.json' };
        
        const CATEGORY_COLORS = {
            'Economic Policy': '#3b82f6',
            'Trade & Industry': '#8b5cf6',
            'Constitutional & Legal': '#ec4899',
            'Technology Policy': '#06b6d4',
            'Healthcare Policy': '#10b981',
            'Defence & Security': '#f97316',
            'Governance & Administration': '#ef4444',
            'Politics': '#f97316',
            'Education Policy': '#a855f7',
            'Environmental Policy': '#22c55e',
            'Infrastructure & Transport': '#8b5cf6',
            'Agricultural Policy': '#84cc16',
            'Energy Policy': '#eab308',
            'Foreign Policy': '#6366f1',
            'Consumer Affairs': '#ec4899',
            'Policy News': '#64748b'
        };
        
        // ============================================================
        // SUSTAINABLE KEYWORD FILTERING
        // Uses: Structural patterns (regex) + Statistical specificity
        // NO hardcoded word lists that require maintenance
        // ============================================================
        
        const KeywordFilter = {
            // Structural patterns - NEVER meaningful regardless of context
            patterns: {
                // Short function words and modals
                functionWord: /^(the|and|for|that|this|with|from|have|been|being|would|could|should|shall|might|must|cannot|will|were|does|also|just|only|more|most|some|such|than|then|very|much|many|each|both|other|another|after|before|against|under|about|above|below|between|through|during|without|within|around|behind|beside|beyond|inside|outside|toward|towards|across|along|among|upon|until|since|into|onto|over|down|near|past|because|although|unless|whether|while|hence|thus|therefore|however|moreover|furthermore|nevertheless|nonetheless|otherwise|instead|besides|meanwhile|thereafter|thereby|whereby|wherein|whereupon|ahead|aside|cannot|addition)$/,
                
                // Reporting/action verbs - these describe HOW news is reported, not WHAT it's about
                reportingVerb: /^(says|said|told|asked|added|noted|claimed|alleged|announced|reported|revealed|launched|proposed|seeking|calling|asking|making|taking|giving|getting|having|being|doing|going|coming|saying|telling|showing|looking|finding|putting|keeping|letting|setting|moving|turning|running|playing|working|trying|leaving|reading|writing|quashed|delay|delayed|delays|death|deaths|projects|companies|approval|price|indian|supreme|section)$/,
                
                // Place suffixes - never meaningful alone
                placeSuffix: /^.{3,}(pur|pura|abad|garh|nagar|ganj|puram|patnam|wadi|khand|vihar)$/,
                
                // Generic modifiers
                genericModifier: /^(major|minor|first|second|third|last|next|previous|current|recent|early|late|new|old|big|small|large|high|low|good|bad|great|best|worst|full|total|entire|whole|final|main|key|top|real|true|false)$/
            },
            
            // Calculate how concentrated a word is in specific categories
            // High specificity = appears in few categories = likely meaningful
            // Low specificity = appears everywhere = likely generic
            calculateSpecificity(categoryDistribution) {
                const counts = Object.values(categoryDistribution);
                if (counts.length === 0) return 0;
                const total = counts.reduce((a, b) => a + b, 0);
                const max = Math.max(...counts);
                // Normalize: 1.0 = appears in only one category, 0.0 = spread evenly
                return max / total;
            },
            
            // Check if word appears in a named entity context
            // e.g., "Gadgil Report", "Swaminathan Committee"
            isNamedEntityContext(word, title) {
                const pattern = new RegExp(
                    `\\b${word}\\s+(report|committee|commission|panel|act|bill|scheme|policy|mission|authority|tribunal|board|council|yojana|abhiyan|niti|programme|program|initiative|framework|guidelines?|rules?|regulations?)\\b`,
                    'i'
                );
                return pattern.test(title);
            },
            
            // Main decision function
            shouldKeep(word, stats) {
                // ALWAYS filter structural patterns - these are noise regardless of frequency
                if (this.patterns.functionWord.test(word)) return false;
                if (this.patterns.reportingVerb.test(word)) return false;
                if (this.patterns.placeSuffix.test(word)) return false;
                if (this.patterns.genericModifier.test(word)) return false;
                
                // Short words need high specificity to survive
                if (word.length < 6 && stats.specificity < 0.6) return false;
                
                // Named entity context boosts importance
                if (stats.hasNamedContext) return true;
                
                // Specificity filter: words spread across many categories are likely generic
                // Threshold: at least 30% of occurrences should be in one category
                if (stats.specificity < 0.3 && stats.count < 5) return false;
                
                // Minimum frequency
                return stats.count >= 2;
            }
        };
        
        // ============================================================
        // PHRASE EXTRACTION - Captures "Gadgil Report", "GST Council"
        // ============================================================
        
        function extractPhrases(title) {
            const phrases = [];
            const regex = /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\s+(Report|Committee|Commission|Panel|Act|Bill|Scheme|Policy|Mission|Authority|Tribunal|Board|Council|Yojana|Abhiyan|Niti|Programme|Program|Initiative|Framework|Guidelines?|Rules?|Regulations?)\b/gi;
            let match;
            while ((match = regex.exec(title)) !== null) {
                phrases.push(match[0].toLowerCase().replace(/\s+/g, '-'));
            }
            return phrases;
        }
        
        // ============================================================
        // ACRONYM DETECTION - Preserves RBI, SEBI, GST, etc.
        // ============================================================
        
        function extractAcronyms(originalTitle) {
            const SKIP = new Set(['THE','AND','FOR','BUT','NOT','ARE','WAS','HAS','HAD','CAN','MAY','NOW','NEW','OLD','TOP','BIG','ALL','ANY','FEW','TWO','ONE','OUR','HIS','HER','ITS','WHO','HOW','WHY','OUT','OFF','OWN','WAY','DAY','MAN','GOT','LET','SAY','SEE','USE','TRY','ASK','PUT','RUN','SET','END','FAR','FEW','KEY','LAW','PAY','TAX','ACT','AID','BAN','BID','CUT','DUE','ERA','FEE','GAP','HIT','JOB','LAP','MAP','NET','OIL','PAN','RAW','ROW','SUM','TIP','VIA','WAR','WIN','YES','YET']);
            const acronyms = originalTitle.match(/\b[A-Z]{2,7}\b/g) || [];
            return acronyms.filter(a => !SKIP.has(a)).map(a => a.toLowerCase());
        }
        
        // ============================================================
        // MULTI-SOURCE VERIFICATION
        // ============================================================
        
        function detectMultiSourceArticles(articles) {
            const groups = new Map();
            
            articles.forEach(art => {
                // Create signature from important words
                const words = art.title.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .split(/\s+/)
                    .filter(w => w.length >= 5)
                    .slice(0, 6)
                    .sort()
                    .join('|');
                
                if (words.length > 15) {
                    if (!groups.has(words)) groups.set(words, []);
                    groups.get(words).push(art);
                }
            });
            
            let verifiedCount = 0;
            groups.forEach(arts => {
                const sources = new Set(arts.map(a => a.source_name));
                if (sources.size >= 2) {
                    arts.forEach(a => {
                        a.multiSource = true;
                        a.sourceCount = sources.size;
                    });
                    verifiedCount += arts.length;
                }
            });
            
            return verifiedCount;
        }
        
        // ============================================================
        // MAIN KEYWORD EXTRACTION
        // ============================================================
        
        function extractKeywords(article) {
            const title = article.title;
            let keywords = [];
            
            // 1. Extract acronyms
            keywords.push(...extractAcronyms(title));
            
            // 2. Extract policy phrases
            keywords.push(...extractPhrases(title));
            
            // 3. Extract single words (4+ chars)
            const words = title.toLowerCase().match(/\b[a-z]{4,}\b/g) || [];
            keywords.push(...words);
            
            return [...new Set(keywords)];
        }
        
        let simulation, physicsEnabled = true, isDarkMode = true;
        
        function initTheme() {
            const saved = localStorage.getItem('policyradar-theme');
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                isDarkMode = false;
                document.getElementById('theme-btn').textContent = 'üåô';
            }
        }
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.getElementById('theme-btn').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            document.documentElement.setAttribute('data-theme', isDarkMode ? '' : 'light');
            localStorage.setItem('policyradar-theme', isDarkMode ? 'dark' : 'light');
            if (isDarkMode) document.documentElement.removeAttribute('data-theme');
        }
        
        async function init() {
            initTheme();
            try {
                const response = await fetch(CONFIG.dataUrl);
                const data = await response.json();
                buildGraph(data.articles || []);
            } catch (e) {
                document.getElementById('loading').innerHTML = '<p style="color:var(--text-muted)">Failed to load data</p>';
            }
        }
        
        function buildGraph(articles) {
            const verifiedCount = detectMultiSourceArticles(articles);
            document.getElementById('stat-verified').textContent = verifiedCount;
            
            const nodes = [], links = [];
            const nodeMap = new Map();
            const kwToArticles = new Map();
            const kwToCategories = new Map();
            const kwNamedContext = new Map();
            
            // Build keyword statistics
            articles.forEach(art => {
                const cat = art.category || 'Policy News';
                const kws = extractKeywords(art);
                
                kws.forEach(kw => {
                    if (!kwToArticles.has(kw)) {
                        kwToArticles.set(kw, []);
                        kwToCategories.set(kw, {});
                        kwNamedContext.set(kw, false);
                    }
                    kwToArticles.get(kw).push(art);
                    kwToCategories.get(kw)[cat] = (kwToCategories.get(kw)[cat] || 0) + 1;
                    
                    if (KeywordFilter.isNamedEntityContext(kw, art.title)) {
                        kwNamedContext.set(kw, true);
                    }
                });
            });
            
            // Filter keywords using sustainable logic
            const filteredKeywords = [];
            kwToArticles.forEach((arts, kw) => {
                const stats = {
                    count: arts.length,
                    specificity: KeywordFilter.calculateSpecificity(kwToCategories.get(kw)),
                    hasNamedContext: kwNamedContext.get(kw)
                };
                
                if (KeywordFilter.shouldKeep(kw, stats)) {
                    filteredKeywords.push({ kw, arts, stats });
                }
            });
            
            // Sort by frequency, take top 60
            filteredKeywords.sort((a, b) => b.arts.length - a.arts.length);
            const topKeywords = filteredKeywords.slice(0, 60);
            
            document.getElementById('stat-keywords').textContent = topKeywords.length;
            
            // Create category nodes
            const categories = [...new Set(articles.map(a => a.category || 'Policy News'))];
            categories.forEach(cat => {
                const catArts = articles.filter(a => (a.category || 'Policy News') === cat);
                const n = {
                    id: `cat_${cat}`, label: cat, type: 'category',
                    size: 42, color: CATEGORY_COLORS[cat] || '#8b7cf7',
                    articles: catArts, hasVerified: catArts.some(a => a.multiSource)
                };
                nodes.push(n);
                nodeMap.set(n.id, n);
            });
            
            // Create keyword nodes
            const maxCount = topKeywords[0]?.arts.length || 1;
            
            topKeywords.forEach(({ kw, arts }) => {
                const ratio = arts.length / maxCount;
                const size = 12 + ratio * 30;
                
                let color = '#fbbf24';
                if (arts.length >= 5) color = '#34d399';
                
                const n = {
                    id: `kw_${kw}`, label: kw, type: 'keyword',
                    size, color, articles: arts, count: arts.length,
                    categories: Object.keys(kwToCategories.get(kw)),
                    hasVerified: arts.some(a => a.multiSource)
                };
                nodes.push(n);
                nodeMap.set(n.id, n);
                
                Object.keys(kwToCategories.get(kw)).forEach(c => {
                    links.push({ source: `cat_${c}`, target: `kw_${kw}`, strength: 0.12 });
                });
            });
            
            // Co-occurrence links
            const pairs = new Map();
            articles.forEach(art => {
                const kws = extractKeywords(art).filter(k => nodeMap.has(`kw_${k}`));
                for (let i = 0; i < kws.length; i++) {
                    for (let j = i + 1; j < kws.length; j++) {
                        const p = [kws[i], kws[j]].sort().join('|');
                        pairs.set(p, (pairs.get(p) || 0) + 1);
                    }
                }
            });
            
            pairs.forEach((cnt, p) => {
                if (cnt >= 2) {
                    const [a, b] = p.split('|');
                    links.push({ source: `kw_${a}`, target: `kw_${b}`, strength: Math.min(cnt / 8, 0.5) });
                }
            });
            
            renderGraph(nodes, links);
        }
        
        function renderGraph(nodes, links) {
            const container = document.getElementById('graph-container');
            const W = container.offsetWidth, H = container.offsetHeight;
            
            const svg = d3.select('#graph-container').append('svg').attr('width', W).attr('height', H);
            const zoom = d3.zoom().scaleExtent([0.15, 4]).on('zoom', e => g.attr('transform', e.transform));
            svg.call(zoom);
            const g = svg.append('g');
            
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id)
                    .distance(d => (d.source.type === 'category' || d.target.type === 'category') ? 120 : 60)
                    .strength(d => d.strength || 0.1))
                .force('charge', d3.forceManyBody().strength(d => d.type === 'category' ? -400 : -50))
                .force('center', d3.forceCenter(W / 2, H / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 4));
            
            const link = g.append('g').selectAll('line').data(links).join('line')
                .attr('class', 'link').attr('stroke-width', d => Math.max(0.5, d.strength * 2));
            
            const node = g.append('g').selectAll('g').data(nodes).join('g')
                .attr('class', d => `node ${d.hasVerified ? 'verified' : ''}`)
                .call(d3.drag()
                    .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
                .on('click', (e, d) => selectNode(d))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            node.append('circle').attr('r', d => d.size).attr('fill', d => d.color).attr('opacity', 0.9);
            
            node.append('text')
                .text(d => {
                    if (d.type === 'category') {
                        const abbr = {
                            'Constitutional & Legal': 'Legal', 'Governance & Administration': 'Gov',
                            'Infrastructure & Transport': 'Infra', 'Trade & Industry': 'Trade',
                            'Economic Policy': 'Economy', 'Technology Policy': 'Tech',
                            'Healthcare Policy': 'Health', 'Defence & Security': 'Defence',
                            'Education Policy': 'Edu', 'Environmental Policy': 'Environ',
                            'Agricultural Policy': 'Agri', 'Energy Policy': 'Energy',
                            'Foreign Policy': 'Foreign', 'Consumer Affairs': 'Consumer',
                            'Policy News': 'News', 'Politics': 'Politics'
                        };
                        return abbr[d.label] || d.label.split(' ')[0];
                    }
                    const maxLen = Math.max(4, Math.floor(d.size * 0.3));
                    return d.label.length > maxLen ? d.label.slice(0, maxLen) : d.label;
                })
                .style('font-size', d => d.type === 'category' ? '10px' : `${Math.max(7, Math.min(10, d.size * 0.3))}px`);
            
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            window.gfx = { svg, g, node, link, zoom, nodes, links };
            document.getElementById('loading').classList.add('hidden');
        }
        
        function selectNode(d) {
            const { node, link } = window.gfx;
            node.classed('selected', n => n.id === d.id);
            link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
            
            document.getElementById('info-panel').classList.add('visible');
            
            document.getElementById('panel-title').innerHTML = d.hasVerified 
                ? `${esc(d.label)} <span class="verified-badge">Multi-Source</span>`
                : esc(d.label);
            
            document.getElementById('panel-meta').textContent = 
                `${d.type === 'category' ? 'Category' : 'Keyword'} ‚Ä¢ ${d.articles.length} articles`;
            
            const related = new Map();
            if (d.type === 'keyword') {
                d.articles.forEach(a => extractKeywords(a).forEach(k => {
                    if (k !== d.label && window.gfx.nodes.find(n => n.id === `kw_${k}`)) {
                        related.set(k, (related.get(k) || 0) + 1);
                    }
                }));
            }
            const topRel = [...related.entries()].sort((a, b) => b[1] - a[1]).slice(0, 8).map(x => x[0]);
            document.getElementById('panel-keywords').innerHTML = topRel.length
                ? topRel.map(k => `<span class="keyword-tag" onclick="findNode('kw_${k}')">${k}</span>`).join('')
                : '<span style="color:var(--text-muted);font-size:0.6875rem">None</span>';
            
            const sortedArticles = [...d.articles].sort((a, b) => {
                if (a.multiSource && !b.multiSource) return -1;
                if (!a.multiSource && b.multiSource) return 1;
                return (b.relevance_score || 0) - (a.relevance_score || 0);
            });
            
            document.getElementById('panel-articles').innerHTML = sortedArticles.slice(0, 5).map(a => `
                <div class="article-card ${a.multiSource ? 'multi-source' : ''}">
                    <div class="article-header">
                        <span class="article-source">${esc(a.source_name)}</span>
                        ${a.multiSource ? `<span class="article-sources-count">${a.sourceCount} sources</span>` : ''}
                    </div>
                    <div class="article-title"><a href="${esc(a.url)}" target="_blank">${esc(a.title)}</a></div>
                </div>
            `).join('');
        }
        
        function findNode(id) {
            const n = window.gfx.nodes.find(x => x.id === id);
            if (n) {
                const W = document.getElementById('graph-container').offsetWidth;
                const H = document.getElementById('graph-container').offsetHeight;
                window.gfx.svg.transition().duration(600).call(window.gfx.zoom.transform,
                    d3.zoomIdentity.translate(W/2, H/2).scale(1.4).translate(-n.x, -n.y));
                selectNode(n);
            }
        }
        
        function closePanel() {
            document.getElementById('info-panel').classList.remove('visible');
            window.gfx.node.classed('selected', false);
            window.gfx.link.classed('highlighted', false);
        }
        
        function showTooltip(e, d) {
            const t = document.getElementById('tooltip');
            t.textContent = `${d.label} (${d.articles.length})${d.hasVerified ? ' ‚úì' : ''}`;
            t.style.left = `${e.pageX + 12}px`;
            t.style.top = `${e.pageY + 12}px`;
            t.classList.add('visible');
        }
        
        function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }
        
        function resetZoom() {
            window.gfx.svg.transition().duration(600).call(window.gfx.zoom.transform, d3.zoomIdentity.scale(0.75));
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            document.getElementById('physics-btn').textContent = physicsEnabled ? '‚è∏' : '‚ñ∂';
            physicsEnabled ? simulation.alpha(0.3).restart() : simulation.stop();
        }
        
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        
        init();
    </script>
</body>
</html>
