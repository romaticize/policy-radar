<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyRadar Knowledge Graph</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-primary: #13111C;
            --bg-secondary: #1a1825;
            --bg-card: #1e1b2e;
            --bg-elevated: #252236;
            --text-primary: #ffffff;
            --text-secondary: #a5a3b3;
            --text-muted: #6b6880;
            --border-color: #2d2a3d;
            --accent-primary: #8b7cf7;
            --accent-secondary: #a78bfa;
            --accent-light: rgba(139, 124, 247, 0.15);
        }
        
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-elevated: #f0f2f5;
            --text-primary: #1a1a2e;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e2e5eb;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-light: rgba(99, 102, 241, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-primary);
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn {
            padding: 7px 14px;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
        }
        
        .btn:hover {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-secondary);
        }
        
        #graph-container {
            width: 100vw;
            height: 100vh;
            padding-top: 56px;
            background: var(--bg-primary);
        }
        
        .node { cursor: pointer; }
        
        .node circle {
            stroke: var(--bg-primary);
            stroke-width: 2px;
            transition: filter 0.2s, stroke-width 0.2s;
        }
        
        .node:hover circle {
            stroke-width: 3px;
            filter: brightness(1.15) drop-shadow(0 0 8px rgba(255,255,255,0.2));
        }
        
        .node.selected circle {
            stroke: #fff;
            stroke-width: 3px;
            filter: drop-shadow(0 0 12px rgba(139, 124, 247, 0.5));
        }
        
        .node text {
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            letter-spacing: -0.3px;
        }
        
        .link {
            stroke: var(--border-color);
            stroke-opacity: 0.25;
        }
        
        .link.highlighted {
            stroke: var(--accent-primary);
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .legend {
            position: fixed;
            top: 76px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 16px;
            z-index: 50;
        }
        
        .legend-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            max-height: 45vh;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: none;
            z-index: 50;
        }
        
        .info-panel.visible { display: block; }
        
        .info-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .info-panel-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .info-panel-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .info-panel-body {
            padding: 14px 16px;
            overflow-y: auto;
            max-height: calc(45vh - 60px);
        }
        
        .info-section { margin-bottom: 14px; }
        
        .info-section-title {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .keyword-tag {
            padding: 3px 8px;
            background: var(--accent-light);
            color: var(--accent-primary);
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        .keyword-tag:hover {
            background: var(--accent-primary);
            color: white;
        }
        
        .article-card {
            padding: 10px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        .article-source {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
        }
        
        .article-title {
            font-size: 0.75rem;
            margin-top: 3px;
            line-height: 1.35;
        }
        
        .article-title a {
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .article-title a:hover { color: var(--accent-primary); }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .tooltip {
            position: fixed;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
        }
        
        .tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <header class="header">
        <div class="logo">üï∏Ô∏è PolicyRadar Knowledge Graph</div>
        <div class="header-controls">
            <button class="btn" onclick="resetZoom()">Reset View</button>
            <button class="btn" onclick="togglePhysics()" id="physics-btn">Pause Physics</button>
            <button class="btn" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è Light Mode</button>
            <a href="topic-explorer.html" class="btn">üî≠ Topic View</a>
            <a href="index.html" class="btn btn-primary">‚Üê Dashboard</a>
        </div>
    </header>
    
    <div class="legend">
        <div class="legend-title">Node Types</div>
        <div class="legend-item"><div class="legend-dot" style="background: #8b7cf7;"></div> Category</div>
        <div class="legend-item"><div class="legend-dot" style="background: #2dd4bf;"></div> Keyword (5+ articles)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #fbbf24;"></div> Keyword (2-4 articles)</div>
    </div>
    
    <div id="graph-container"></div>
    
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header">
            <div class="info-panel-title" id="panel-title">-</div>
            <div class="info-panel-meta" id="panel-meta">-</div>
        </div>
        <div class="info-panel-body">
            <div class="info-section">
                <div class="info-section-title">Related Keywords</div>
                <div class="keyword-tags" id="panel-keywords"></div>
            </div>
            <div class="info-section">
                <div class="info-section-title">Sample Articles</div>
                <div id="panel-articles"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        const CONFIG = { dataUrl: 'data/public_data.json' };
        
        const CATEGORY_COLORS = {
            'Economic Policy': '#3b82f6',
            'Trade & Industry': '#8b5cf6',
            'Constitutional & Legal': '#ec4899',
            'Technology Policy': '#06b6d4',
            'Healthcare Policy': '#10b981',
            'Defence & Security': '#f97316',
            'Governance & Administration': '#ef4444',
            'Politics': '#f97316',
            'Education Policy': '#8b5cf6',
            'Environmental Policy': '#22c55e',
            'Infrastructure & Transport': '#a855f7',
            'Agricultural Policy': '#84cc16',
            'Energy Policy': '#eab308',
            'Foreign Policy': '#6366f1',
            'Consumer Affairs': '#ec4899',
            'Policy News': '#64748b'
        };
        
        // ============================================================
        // SUSTAINABLE KEYWORD EXTRACTION SYSTEM
        // No hardcoded whitelists/blacklists of specific words
        // Uses structural patterns and statistical analysis only
        // ============================================================
        
        const KeywordExtractor = {
            // -------- STRUCTURAL FILTERS (Pattern-based, not word-based) --------
            
            // Place name suffixes (Indian place naming patterns)
            PLACE_SUFFIX_PATTERN: /^.{2,}(pur|pura|abad|garh|nagar|ganj|wadi|puram|patnam|bad|khand|vihar)$/,
            
            // Municipal corporations and local bodies (noise in policy context)
            MUNICIPAL_PATTERN: /^(municipal|corporation|municip|brihanmumbai|thane|nashik|pune|navi|greater|urban|civic|zilla|panchayat|taluka|tehsil|cantonment)/i,
            
            // Generic finance/company suffixes that create noise
            COMPANY_NOISE_PATTERN: /^.{2,}(securities|finance|financi|equities|wealth|capital|ventures|holdings|limited|solutions|services|enterprises|industries|infra|realty|developers|investments|consultants|advisors|partners|technologies|pharma|foods|textiles|motors|auto|steel|cement|power|energy|chemicals|polymers|plastics)$/i,
            
            // Generic bank names (not policy-relevant)
            GENERIC_BANK_PATTERN: /^(first|city|metro|state|central|rural|cooperative|gramin|sahakari|nagari)[\s-]*(bank|credit)/i,
            
            // Person name patterns (Indian names)
            PERSON_NAME_PATTERN: /^(kumar|sharma|singh|gupta|verma|agarwal|jain|patel|shah|mehta|reddy|rao|naidu|choudhary|choudhury|mishra|pandey|tiwari|yadav|chauhan|rajput|thakur|nair|menon|pillai|iyer|iyengar|mukherjee|banerjee|chatterjee|bhattacharya|das|bose|sen|roy|ghosh|dutta|sinha|prasad|prakash|satya|sunita|priya|rahul|vijay|amit|sumit|ankit|rohit|deepak|rakesh|suresh|ramesh|mahesh|ganesh|dinesh|rajesh|mukesh|naresh)$/i,
            
            // Reporting/news verb patterns (gerunds and common forms)
            REPORTING_VERB_PATTERN: /^(says?|said|told?|tells?|ask(?:s|ed|ing)?|add(?:s|ed|ing)?|not(?:es?|ed|ing)|claim(?:s|ed|ing)?|alleg(?:es?|ed|ing)|announc(?:es?|ed|ing)|report(?:s|ed|ing)?|reveal(?:s|ed|ing)?|launch(?:es?|ed|ing)?|propos(?:es?|ed|ing)?|seek(?:s|ing)?|sought|call(?:s|ed|ing)?|urg(?:es?|ed|ing)|warn(?:s|ed|ing)?|declar(?:es?|ed|ing)|stat(?:es?|ed|ing)|confirm(?:s|ed|ing)?|den(?:y|ies|ied|ying)|admit(?:s|ted|ting)?|argu(?:es?|ed|ing)|believ(?:es?|ed|ing)|expect(?:s|ed|ing)?|hop(?:es?|ed|ing)|fear(?:s|ed|ing)?|demand(?:s|ed|ing)?|order(?:s|ed|ing)?|direct(?:s|ed|ing)?|pass(?:es|ed|ing)?|approv(?:es?|ed|ing)|impos(?:es?|ed|ing)|deliver(?:s|ed|ing)?|clear(?:s|ed|ing)?|review(?:s|ed|ing)?|uphold(?:s|ing)?|upheld|defer(?:s|red|ring)?|issu(?:es?|ed|ing)|fil(?:es?|ed|ing)|mov(?:es?|ed|ing)|grant(?:s|ed|ing)?|reject(?:s|ed|ing)?|dismiss(?:es|ed|ing)?|allow(?:s|ed|ing)?|ban(?:s|ned|ning)?|block(?:s|ed|ing)?|boost(?:s|ed|ing)?|slash(?:es|ed|ing)?|hik(?:es?|ed|ing)|slash(?:es|ed|ing)?|scraps?|scrap(?:s|ped|ping)?)$/,
            
            // Generic action verbs
            ACTION_VERB_PATTERN: /^(get(?:s|ting)?|got|make(?:s|ing)?|made|tak(?:es?|ing)|took|taken|giv(?:es?|ing)|gave|given|come(?:s|ing)?|came|go(?:es|ing)?|went|gone|know(?:s|ing)?|knew|known|think(?:s|ing)?|thought|see(?:s|ing)?|saw|seen|want(?:s|ed|ing)?|use[ds]?|using|find(?:s|ing)?|found|put(?:s|ting)?|keep(?:s|ing)?|kept|let(?:s|ting)?|begin(?:s|ning)?|began|begun|set(?:s|ting)?|show(?:s|ed|ing)?|shown|bring(?:s|ing)?|brought|turn(?:s|ed|ing)?|start(?:s|ed|ing)?|run(?:s|ning)?|ran|meet(?:s|ing)?|met|pay(?:s|ing)?|paid|hear(?:s|ing)?|heard|play(?:s|ed|ing)?|stand(?:s|ing)?|stood|leav(?:es?|ing)|left|watch(?:es|ed|ing)?|feel(?:s|ing)?|felt|becom(?:es?|ing)|became|look(?:s|ed|ing)?|build(?:s|ing)?|built|face[ds]?|facing|join(?:s|ed|ing)?|hit(?:s|ting)?|pick(?:s|ed|ing)?|back(?:s|ed|ing)?|name[ds]?|naming|help(?:s|ed|ing)?|need(?:s|ed|ing)?|creat(?:es?|ed|ing)|form(?:s|ed|ing)?|hold(?:s|ing)?|held|open(?:s|ed|ing)?|clos(?:es?|ed|ing)|includ(?:es?|ed|ing)|continu(?:es?|ed|ing)|chang(?:es?|ed|ing)|provid(?:es?|ed|ing)|receiv(?:es?|ed|ing)|remain(?:s|ed|ing)?|rais(?:es?|ed|ing)|follow(?:s|ed|ing)?|requir(?:es?|ed|ing)|decid(?:es?|ed|ing)|return(?:s|ed|ing)?|explain(?:s|ed|ing)?|develop(?:s|ed|ing)?|support(?:s|ed|ing)?|present(?:s|ed|ing)?|discuss(?:es|ed|ing)?|tr(?:y|ies|ied|ying)|win(?:s|ning)?|won|los(?:es?|ing)|lost|liv(?:es?|ed|ing)|d(?:ie[ds]?|ying)|spend(?:s|ing)?|spent|grow(?:s|ing)?|grew|grown|stop(?:s|ped|ping)?|stay(?:s|ed|ing)?|fall(?:s|ing)?|fell|fallen|lead(?:s|ing)?|led|speak(?:s|ing)?|spoke|spoken|accept(?:s|ed|ing)?|carr(?:y|ies|ied|ying)|happen(?:s|ed|ing)?|writ(?:es?|ing)|wrote|written|sit(?:s|ting)?|sat|appear(?:s|ed|ing)?|cover(?:s|ed|ing)?|produc(?:es?|ed|ing)|represent(?:s|ed|ing)?|serv(?:es?|ed|ing)|appl(?:y|ies|ied|ying)|invest(?:s|ed|ing)?|shar(?:es?|ed|ing)|buy(?:s|ing)?|bought|sell(?:s|ing)?|sold|send(?:s|ing)?|sent|arrest(?:s|ed|ing)?|search(?:es|ed|ing)?|raid(?:s|ed|ing)?|push(?:es|ed|ing)?|pull(?:s|ed|ing)?)$/,
            
            // Generic adjectives and adverbs
            GENERIC_MODIFIER_PATTERN: /^(major|minor|first|second|third|fourth|fifth|last|next|previous|current|recent|recently|early|late|soon|later|earlier|new|old|big|small|large|huge|great|good|better|best|bad|worse|worst|high|low|higher|lower|highest|lowest|top|full|empty|complete|total|entire|whole|final|initial|basic|simple|complex|easy|hard|difficult|strong|weak|fast|slow|quick|long|short|likely|unlikely|possible|impossible|necessary|available|ready|clear|real|true|false|right|wrong|free|special|general|specific|particular|certain|various|different|similar|same|other|important|significant|critical|crucial|essential|primary|secondary|political|national|international|local|global|foreign|domestic|regional|public|private|social|economic|financial|official|legal|civic)$/,
            
            // Generic nouns that appear in all contexts
            GENERIC_NOUN_PATTERN: /^(government|minister|ministry|official|authority|department|committee|commission|council|agency|board|office|leader|member|people|person|citizen|country|nation|state|union|centre|center|action|issue|matter|party|group|team|system|level|area|region|zone|number|point|place|result|effect|impact|reason|cause|problem|solution|question|answer|decision|agreement|meeting|session|report|study|survey|review|analysis|detail|record|source|benefit|challenge|opportunity|concern|interest|target|effort|attempt|measure|scheme|project|program|initiative|mission|vision|statement|comment|response|message|service|sector|market|industry|company|business|growth|development|progress|process|reform|change|increase|decrease|crisis|situation|condition|status|event|incident|case|order|notice|rule|guideline|norm|right|freedom|power|role|position|world|society|community)$/,
            
            // Time-related words
            TIME_PATTERN: /^(year|years|month|months|week|weeks|day|days|today|yesterday|tomorrow|time|times|hour|hours|minute|minutes|second|seconds|morning|evening|night|monday|tuesday|wednesday|thursday|friday|saturday|sunday|january|february|march|april|june|july|august|september|october|november|december|annual|quarterly|daily|weekly|monthly|yearly|winter|summer|spring|autumn)$/,
            
            // Numbers and quantities
            NUMBER_PATTERN: /^(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|hundred|thousand|million|billion|crore|lakh|percent|percentage|half|quarter|double|triple|single|multiple|several|many|much|few|little|more|most|less|least)$/,
            
            // Common connectors and fillers
            FILLER_PATTERN: /^(also|just|only|even|still|already|yet|ever|never|always|often|sometimes|usually|actually|really|certainly|definitely|probably|possibly|perhaps|maybe|obviously|clearly|apparently|however|therefore|moreover|furthermore|nevertheless|meanwhile|otherwise|instead|despite|regardless|whether|hence|thus|accordingly|basically|essentially|generally|normally|typically)$/,
            
            // Policy indicator words (for phrase extraction)
            POLICY_INDICATORS: ['report', 'committee', 'commission', 'panel', 'act', 'bill', 'scheme', 'policy', 'tribunal', 'authority', 'board', 'council', 'mission', 'yojana', 'abhiyan', 'ordinance', 'amendment', 'framework', 'guidelines'],
            
            // -------- EXTRACTION METHODS --------
            
            // Extract acronyms from original (case-preserved) title
            extractAcronyms(originalTitle) {
                const matches = originalTitle.match(/\b[A-Z]{2,6}\b/g) || [];
                const COMMON_CAPS = new Set(['THE', 'A', 'AN', 'IN', 'ON', 'AT', 'TO', 'FOR', 'OF', 'BY', 'AS', 'IS', 'IT', 'PM', 'CM', 'MP', 'AM']);
                return matches.filter(a => !COMMON_CAPS.has(a)).map(a => a.toLowerCase());
            },
            
            // Extract policy-relevant phrases like "Gadgil Report", "GST Council"
            extractPolicyPhrases(originalTitle) {
                const phrases = [];
                const indicatorPattern = this.POLICY_INDICATORS.join('|');
                
                // Pattern: [ProperNoun] + [PolicyIndicator]
                const regex = new RegExp(`\\b([A-Z][a-z]+(?:\\s+[A-Z][a-z]+)?)\\s+(${indicatorPattern})\\b`, 'gi');
                let match;
                while ((match = regex.exec(originalTitle)) !== null) {
                    phrases.push(match[0].toLowerCase().replace(/\s+/g, '-'));
                }
                
                // Pattern: [Acronym] + [PolicyIndicator]
                const acronymRegex = new RegExp(`\\b([A-Z]{2,6})\\s+(${indicatorPattern})\\b`, 'gi');
                while ((match = acronymRegex.exec(originalTitle)) !== null) {
                    phrases.push(match[0].toLowerCase().replace(/\s+/g, '-'));
                }
                
                return phrases;
            },
            
            // Check if word passes structural filters
            passesStructuralFilters(word) {
                if (word.length < 5) return false;
                if (this.PLACE_SUFFIX_PATTERN.test(word)) return false;
                if (this.MUNICIPAL_PATTERN.test(word)) return false;
                if (this.COMPANY_NOISE_PATTERN.test(word)) return false;
                if (this.GENERIC_BANK_PATTERN.test(word)) return false;
                if (this.PERSON_NAME_PATTERN.test(word)) return false;
                if (this.REPORTING_VERB_PATTERN.test(word)) return false;
                if (this.ACTION_VERB_PATTERN.test(word)) return false;
                if (this.GENERIC_MODIFIER_PATTERN.test(word)) return false;
                if (this.GENERIC_NOUN_PATTERN.test(word)) return false;
                if (this.TIME_PATTERN.test(word)) return false;
                if (this.NUMBER_PATTERN.test(word)) return false;
                if (this.FILLER_PATTERN.test(word)) return false;
                return true;
            },
            
            // Check if a keyword/phrase should be blocked as noise
            isNoiseEntity(keyword) {
                const kw = keyword.toLowerCase();
                
                // GENERIC GEOGRAPHIC TERMS - too ubiquitous to be meaningful
                // These appear in almost all articles and don't add discriminatory value
                if (/^(india|indian|bharat|bharatiya|country|nation|national)$/i.test(kw)) return true;
                
                // Generic temporal/sequence words that slip through
                if (/^(after|before|under|during|between|within|above|below|behind|ahead|among|inside|outside|around|against|towards|across|along|through)$/i.test(kw)) return true;
                
                // Modal and auxiliary verbs that slip through
                if (/^(could|would|should|might|must|shall|being|having|doing|going|coming|getting|making|taking|giving|saying|looking|trying|asking|working|calling|moving|looking|turning|leaving|playing|running|reading|writing|living|thinking|feeling|becoming|putting|keeping|letting|beginning|seeming|meaning|helping|showing|hearing|playing|knowing|standing|holding|bringing|setting|sitting|meeting|learning|paying|buying|watching|leading|speaking|starting|opening|closing|following|allowing|including|continuing)$/i.test(kw)) return true;
                
                // Generic nouns that appear everywhere
                if (/^(users|chief|rules|talks|content|digital|value|views|issues|things|point|points|matter|matters|group|groups|level|levels|place|places|world|areas|parts|types|kinds|forms|cases|terms|needs|means|works|lines|hands|words|ideas|plans|steps|ways|days|years|times|months|hours|weeks|percent|numbers|details|results|reports|people|person|member|members|leader|leaders|official|officials|sources|records|figures|amounts|rates|prices|costs|charges|accounts|claims|rights|powers|forces|efforts|attempts|measures|actions|activities|events|changes|effects|impacts|reasons|causes|factors|aspects|features|benefits|challenges|concerns|interests|matters|questions|answers|problems|solutions|options|choices|decisions|agreements|arrangements|conditions|situations|circumstances|opportunities|experiences|developments|improvements|achievements|statements|comments|responses|messages|warnings|reports|studies|surveys|reviews|analyses|proposals|suggestions|recommendations|guidelines|standards|requirements|regulations|provisions|procedures|processes|practices|policies|strategies|initiatives|programs|projects|schemes|missions|campaigns|operations|transactions|investments|payments|contributions|donations|grants|funds|loans|debts|assets|liabilities|profits|losses|revenues|expenses|budgets|estimates|forecasts|targets|goals|objectives|priorities|principles|values|beliefs|opinions|perspectives|approaches|methods|techniques|tools|systems|structures|frameworks|models|patterns|trends|cycles|phases|stages|rounds|versions|editions|updates|releases|launches|announcements|declarations|appointments|nominations|elections|votes|polls|debates|discussions|negotiations|meetings|sessions|conferences|summits|forums|events|ceremonies|celebrations|festivals|exhibitions|shows|performances|matches|games|contests|competitions|races|trials|tests|exams|interviews|surveys|audits|inspections|investigations|inquiries|hearings|proceedings|trials|judgments|verdicts|rulings|orders|notices|warnings|alerts|signals|signs|symptoms|indicators|markers|benchmarks|milestones|landmarks|monuments|buildings|facilities|infrastructure|equipment|machinery|vehicles|aircraft|ships|weapons|devices|instruments|appliances|gadgets|products|goods|items|materials|resources|supplies|stocks|reserves|deposits|collections|sets|series|ranges|varieties|categories|classes|divisions|sections|departments|units|teams|committees|boards|councils|agencies|bodies|organizations|institutions|establishments|companies|corporations|firms|businesses|enterprises|industries|sectors|markets|economies|societies|communities|populations|nations|countries|states|regions|provinces|territories|districts|cities|towns|villages|locations|sites|venues|destinations)$/i.test(kw)) return true;
                
                // Short generic words (2-4 chars) that aren't acronyms
                if (kw.length <= 4 && !/^[A-Z]{2,4}$/.test(keyword)) {
                    if (/^(also|just|only|even|still|many|much|most|some|such|same|well|good|best|high|low|new|old|big|top|key|due|per|own|last|next|back|full|long|late|real|true|main|major|minor|base|core|wide|deep|near|away|left|right|down|over|into|onto|upon|than|like|with|from|about|been|have|were|will|more|very|when|what|which|where|while|other)$/i.test(kw)) return true;
                }
                
                // State names without policy context
                if (/^(kerala|tamil|assam|bengal|bihar|odisha|punjab|haryana|uttarakhand|chhattisgarh|jharkhand|manipur|meghalaya|mizoram|nagaland|sikkim|tripura|arunachal|telangana|andhra|madhya|uttar|himachal|jammu|kashmir)$/i.test(kw)) return true;
                
                // Municipal corporations and local bodies
                if (/municipal|corporation|panchayat|zilla|taluka|cantonment/i.test(kw)) return true;
                // Generic finance companies
                if (/securities|equities|wealth|capital|ventures|holdings|finance|financi/i.test(kw)) return true;
                // Generic company suffixes
                if (/limited|solutions|services|enterprises|industries|technologies|consultants|advisors|partners/i.test(kw)) return true;
                // Generic banks (not RBI, SBI, or policy-relevant banks)
                if (/first\s*bank|city\s*bank|metro\s*bank|cooperative|gramin|sahakari|nagari/i.test(kw)) return true;
                // Private bank names that aren't policy-relevant
                if (/kotak|hdfc|icici|axis|yes\s*bank|indusind|bandhan|idfc|rbl|federal\s*bank/i.test(kw) && !/reserve|rbi|regulation|policy|circular|guideline/i.test(kw)) return true;
                // Place names as companies (but allow courts/tribunals)
                if (/thane|nashik|pune|mumbai|delhi|chennai|kolkata|bangalore|hyderabad/i.test(kw) && !/\b(high\s*court|hc|tribunal|bench)\b/i.test(kw)) return true;
                // Generic realty/infra
                if (/realty|developers|builders|real\s*estate|housing|properties/i.test(kw)) return true;
                // Person names (common Indian names)
                if (/^(satya|sunita|priya|rahul|vijay|amit|sumit|ankit|rohit|deepak|rakesh|suresh|ramesh|mahesh|ganesh|dinesh|rajesh|mukesh|naresh|kumar|sharma|singh|gupta|verma|patel|shah|mehta|reddy|rao)/i.test(kw)) return true;
                // Stock market terms (not policy)
                if (/shares|stock|nse|bse|sensex|nifty|trading|intraday|delivery|demat/i.test(kw)) return true;
                // Generic legal terms without specificity
                if (/allahabad|madras|calcutta|bombay|karnataka|kerala|gujarat|rajasthan|orissa|jharkhand|chhattisgarh|mp|up|bihar/i.test(kw) && !/\b(high\s*court|hc|tribunal|bench|act|bill)\b/i.test(kw)) return true;
                return false;
            },
            
            // Main extraction function
            extract(article) {
                const title = article.title || '';
                const keywords = [];
                
                // 1. Extract acronyms (always keep)
                keywords.push(...this.extractAcronyms(title));
                
                // 2. Extract policy phrases
                keywords.push(...this.extractPolicyPhrases(title));
                
                // 3. Extract single words (5+ chars, passing structural filters)
                const words = title.toLowerCase().match(/\b[a-z]{5,}\b/g) || [];
                words.forEach(word => {
                    if (this.passesStructuralFilters(word)) {
                        keywords.push(word);
                    }
                });
                
                return [...new Set(keywords)];
            },
            
            // -------- STATISTICAL FILTER: Category Specificity --------
            // Words concentrated in specific categories are policy-relevant
            // Words spread evenly across all categories are generic
            
            calculateSpecificity(categoryDistribution) {
                const counts = Object.values(categoryDistribution);
                if (counts.length === 0) return 0;
                const total = counts.reduce((a, b) => a + b, 0);
                const max = Math.max(...counts);
                return max / total; // 1.0 = appears in only one category, 0.1 = spread across 10
            },
            
            // Filter keywords by specificity threshold
            filterBySpecificity(keywordMap, threshold = 0.3) {
                const filtered = {};
                
                Object.entries(keywordMap).forEach(([keyword, data]) => {
                    // Skip noise entities (municipal corps, generic companies, etc.)
                    if (this.isNoiseEntity(keyword)) return;
                    
                    const specificity = this.calculateSpecificity(data.categoryDistribution);
                    
                    // Keep if:
                    // - High specificity (concentrated in few categories), OR
                    // - Is a phrase (contains hyphen), OR
                    // - Is an acronym (all uppercase in original)
                    if (specificity >= threshold || keyword.includes('-') || data.isAcronym) {
                        filtered[keyword] = { ...data, specificity };
                    }
                });
                
                return filtered;
            }
        };
        
        // ============================================================
        // GRAPH BUILDING
        // ============================================================
        
        let simulation, physicsEnabled = true, isDarkMode = true;
        
        function initTheme() {
            const saved = localStorage.getItem('policyradar-theme');
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                isDarkMode = false;
                document.getElementById('theme-btn').textContent = 'üåô Dark Mode';
            }
        }
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.getElementById('theme-btn').textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            if (isDarkMode) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('policyradar-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('policyradar-theme', 'light');
            }
        }
        
        async function init() {
            initTheme();
            try {
                const response = await fetch(CONFIG.dataUrl);
                const data = await response.json();
                buildGraph(data.articles || []);
            } catch (e) {
                document.getElementById('loading').innerHTML = '<p style="color:#888">Failed to load data</p>';
            }
        }
        
        function buildGraph(articles) {
            const nodes = [], links = [];
            const nodeMap = new Map();
            
            // Build keyword map with category distribution
            const keywordMap = {};
            
            articles.forEach(article => {
                const category = article.category || 'Policy News';
                const keywords = KeywordExtractor.extract(article);
                
                keywords.forEach(kw => {
                    if (!keywordMap[kw]) {
                        keywordMap[kw] = {
                            articles: [],
                            categoryDistribution: {},
                            isAcronym: /^[a-z]{2,6}$/.test(kw) && article.title.includes(kw.toUpperCase())
                        };
                    }
                    keywordMap[kw].articles.push(article);
                    keywordMap[kw].categoryDistribution[category] = (keywordMap[kw].categoryDistribution[category] || 0) + 1;
                });
            });
            
            // Apply specificity filter
            const filteredKeywords = KeywordExtractor.filterBySpecificity(keywordMap, 0.3);
            
            // Category nodes
            const categories = [...new Set(articles.map(a => a.category || 'Policy News'))];
            categories.forEach(cat => {
                const catArts = articles.filter(a => (a.category || 'Policy News') === cat);
                const n = {
                    id: `cat_${cat}`, label: cat, type: 'category',
                    size: 45, color: CATEGORY_COLORS[cat] || '#8b7cf7', articles: catArts
                };
                nodes.push(n);
                nodeMap.set(n.id, n);
            });
            
            // Keyword nodes (top 70 by frequency, min 2 articles)
            const topKeywords = Object.entries(filteredKeywords)
                .filter(([kw, data]) => data.articles.length >= 2)
                .sort((a, b) => b[1].articles.length - a[1].articles.length)
                .slice(0, 70);
            
            const maxCount = topKeywords[0]?.[1].articles.length || 1;
            
            topKeywords.forEach(([kw, data]) => {
                const count = data.articles.length;
                const ratio = count / maxCount;
                
                // Calculate size - make circles big enough for text
                // Minimum radius = 4px per character to fit text
                const minRadiusForText = kw.length * 4;
                const frequencySize = 18 + ratio * 35;
                const size = Math.max(minRadiusForText, frequencySize);
                
                let color = '#fbbf24'; // 2-4 articles (amber)
                if (count >= 5) color = '#2dd4bf'; // 5+ articles (teal)
                
                const n = {
                    id: `kw_${kw}`, label: kw, type: 'keyword',
                    size, color, articles: data.articles, count,
                    specificity: data.specificity,
                    categories: Object.keys(data.categoryDistribution)
                };
                nodes.push(n);
                nodeMap.set(n.id, n);
                
                // Link to categories
                Object.keys(data.categoryDistribution).forEach(cat => {
                    links.push({ source: `cat_${cat}`, target: `kw_${kw}`, strength: 0.15 });
                });
            });
            
            // Co-occurrence links
            const pairs = new Map();
            articles.forEach(art => {
                const kws = KeywordExtractor.extract(art).filter(k => nodeMap.has(`kw_${k}`));
                for (let i = 0; i < kws.length; i++) {
                    for (let j = i + 1; j < kws.length; j++) {
                        const p = [kws[i], kws[j]].sort().join('|');
                        pairs.set(p, (pairs.get(p) || 0) + 1);
                    }
                }
            });
            pairs.forEach((cnt, p) => {
                if (cnt >= 2) {
                    const [a, b] = p.split('|');
                    links.push({ source: `kw_${a}`, target: `kw_${b}`, strength: cnt / 6 });
                }
            });
            
            renderGraph(nodes, links);
        }
        
        function renderGraph(nodes, links) {
            const container = document.getElementById('graph-container');
            const W = container.offsetWidth, H = container.offsetHeight;
            
            const svg = d3.select('#graph-container').append('svg').attr('width', W).attr('height', H);
            const zoom = d3.zoom().scaleExtent([0.2, 4]).on('zoom', e => g.attr('transform', e.transform));
            svg.call(zoom);
            const g = svg.append('g');
            
            // Initialize nodes with random positions for bubbling effect
            nodes.forEach(node => {
                node.x = W/2 + (Math.random() - 0.5) * W * 0.6;
                node.y = H/2 + (Math.random() - 0.5) * H * 0.6;
                node.vx = (Math.random() - 0.5) * 8; // Initial velocity for bubbling
                node.vy = (Math.random() - 0.5) * 8;
            });
            
            simulation = d3.forceSimulation(nodes)
                .alpha(1.2)           // Start with high energy for bubbling
                .alphaDecay(0.015)    // Slow decay for longer bubbling effect
                .alphaMin(0.001)      // Stop when settled
                .velocityDecay(0.3)   // Lower friction for more movement
                .force('link', d3.forceLink(links).id(d => d.id)
                    .distance(d => (d.source.type === 'category' || d.target.type === 'category') ? 120 : 60)
                    .strength(d => d.strength || 0.12))
                .force('charge', d3.forceManyBody().strength(d => d.type === 'category' ? -400 : -80))
                .force('center', d3.forceCenter(W / 2, H / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 5).strength(0.8))
                .force('x', d3.forceX(W / 2).strength(0.02))
                .force('y', d3.forceY(H / 2).strength(0.02));
            
            const link = g.append('g').selectAll('line').data(links).join('line')
                .attr('class', 'link').attr('stroke-width', d => Math.max(0.5, d.strength));
            
            const node = g.append('g').selectAll('g').data(nodes).join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
                .on('click', (e, d) => selectNode(d))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            node.append('circle').attr('r', d => d.size).attr('fill', d => d.color).attr('opacity', 0.92);
            
            // Text inside circles - CENTERED
            node.append('text')
                .text(d => {
                    if (d.type === 'category') {
                        const abbr = {
                            'Constitutional & Legal': 'Legal',
                            'Governance & Administration': 'Govern',
                            'Infrastructure & Transport': 'Infra',
                            'Trade & Industry': 'Trade',
                            'Economic Policy': 'Economy',
                            'Technology Policy': 'Tech',
                            'Healthcare Policy': 'Health',
                            'Defence & Security': 'Defence',
                            'Education Policy': 'Edu',
                            'Environmental Policy': 'Environ',
                            'Agricultural Policy': 'Agri',
                            'Energy Policy': 'Energy',
                            'Foreign Policy': 'Foreign',
                            'Consumer Affairs': 'Consumer',
                            'Policy News': 'News',
                            'Social Policy': 'Social'
                        };
                        return abbr[d.label] || d.label.split(' ')[0];
                    }
                    return d.label;
                })
                .attr('x', 0)
                .attr('y', 0)
                .attr('dy', '0.35em')  // Vertical centering adjustment
                .attr('text-anchor', 'middle')
                .style('font-size', d => {
                    if (d.type === 'category') return '12px';
                    const diameter = d.size * 2;
                    const chars = d.label.length;
                    const fittedSize = diameter / (chars * 0.55);
                    return `${Math.max(8, Math.min(13, fittedSize))}px`;
                })
                .style('font-weight', d => d.type === 'category' ? '700' : '600');
            
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            // Auto-settle after bubbling (increase friction after 3 seconds)
            setTimeout(() => {
                simulation.velocityDecay(0.5);
            }, 3000);
            
            window.gfx = { svg, g, node, link, zoom, nodes, links };
            document.getElementById('loading').classList.add('hidden');
        }
        
        function selectNode(d) {
            const { node, link } = window.gfx;
            node.classed('selected', n => n.id === d.id);
            link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
            
            document.getElementById('info-panel').classList.add('visible');
            document.getElementById('panel-title').textContent = d.label;
            document.getElementById('panel-meta').textContent = `${d.type === 'category' ? 'Category' : 'Keyword'} ‚Ä¢ ${d.articles.length} articles`;
            
            const related = new Map();
            if (d.type === 'keyword') {
                d.articles.forEach(a => KeywordExtractor.extract(a).forEach(k => {
                    if (k !== d.label) related.set(k, (related.get(k) || 0) + 1);
                }));
            }
            const topRel = [...related.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10).map(x => x[0]);
            document.getElementById('panel-keywords').innerHTML = topRel.length
                ? topRel.map(k => `<span class="keyword-tag" onclick="findNode('kw_${k}')">${k}</span>`).join('')
                : '<span style="color:var(--text-muted)">None</span>';
            
            document.getElementById('panel-articles').innerHTML = d.articles.slice(0, 4).map(a => `
                <div class="article-card">
                    <div class="article-source">${esc(a.source_name)}</div>
                    <div class="article-title"><a href="${esc(a.url)}" target="_blank">${esc(a.title)}</a></div>
                </div>
            `).join('');
        }
        
        function findNode(id) {
            const n = window.gfx.nodes.find(x => x.id === id);
            if (n) {
                const W = document.getElementById('graph-container').offsetWidth;
                const H = document.getElementById('graph-container').offsetHeight;
                window.gfx.svg.transition().duration(700).call(window.gfx.zoom.transform,
                    d3.zoomIdentity.translate(W/2, H/2).scale(1.5).translate(-n.x, -n.y));
                selectNode(n);
            }
        }
        
        function showTooltip(e, d) {
            const t = document.getElementById('tooltip');
            t.textContent = `${d.label} (${d.articles.length})`;
            t.style.left = `${e.pageX + 10}px`;
            t.style.top = `${e.pageY + 10}px`;
            t.classList.add('visible');
        }
        
        function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }
        
        function resetZoom() {
            window.gfx.svg.transition().duration(700).call(window.gfx.zoom.transform, d3.zoomIdentity.scale(0.8));
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            document.getElementById('physics-btn').textContent = physicsEnabled ? 'Pause Physics' : 'Resume Physics';
            physicsEnabled ? simulation.alpha(0.3).restart() : simulation.stop();
        }
        
        function esc(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        
        init();
    </script>
</body>
</html>
